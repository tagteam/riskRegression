<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="This function is used internally to obtain
inverse of the probability of censoring weights."><title>Estimation of censoring probabilities — ipcw • riskRegression</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimation of censoring probabilities — ipcw"><meta property="og:description" content="This function is used internally to obtain
inverse of the probability of censoring weights."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">riskRegression</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2022.03.06</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/tagteam/riskRegression/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Estimation of censoring probabilities</h1>
      <small class="dont-index">Source: <a href="https://github.com/tagteam/riskRegression/blob/HEAD/R/ipcw.R" class="external-link"><code>R/ipcw.R</code></a></small>
      <div class="d-none name"><code>ipcw.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function is used internally to obtain
inverse of the probability of censoring weights.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="fu">ipcw</span><span class="op">(</span>
  <span class="va">formula</span>,
  <span class="va">data</span>,
  <span class="va">method</span>,
  <span class="va">args</span>,
  <span class="va">times</span>,
  <span class="va">subject.times</span>,
  lag <span class="op">=</span> <span class="fl">1</span>,
  <span class="va">what</span>,
  keep <span class="op">=</span> <span class="cn">NULL</span>
<span class="op">)</span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>formula</dt>
<dd><p>A survival formula like, <code>Surv(time,status)~1</code>, where
as usual status=0 means censored. The status variable is internally
reversed for estimation of censoring rather than survival
probabilities. Some of the available models (see argument
<code>model</code>) will use predictors on the right hand side of the
formula.</p></dd>
<dt>data</dt>
<dd><p>The data used for fitting the censoring model</p></dd>
<dt>method</dt>
<dd><p>Censoring model used for estimation of the
(conditional) censoring distribution.</p></dd>
<dt>args</dt>
<dd><p>A list of arguments which is passed to method</p></dd>
<dt>times</dt>
<dd><p>For <code>what="IPCW.times"</code> a vector of times at
which to compute the probabilities of not being censored.</p></dd>
<dt>subject.times</dt>
<dd><p>For <code>what="IPCW.subject.times"</code> a vector of
individual times at which the probabilities of not being censored
are computed.</p></dd>
<dt>lag</dt>
<dd><p>If equal to <code>1</code> then obtain
<code>G(T_i-|X_i)</code>, if equal to <code>0</code> estimate the conditional
censoring distribution at the subject.times,
i.e. (<code>G(T_i|X_i)</code>).</p></dd>
<dt>what</dt>
<dd><p>Decide about what to do: If equal to
<code>"IPCW.times"</code> then weights are estimated at given
<code>times</code>.  If equal to <code>"IPCW.subject.times"</code> then weights
are estimated at individual <code>subject.times</code>.  If missing then
produce both.</p></dd>
<dt>keep</dt>
<dd><p>Which elements to add to the output. Any subset of the vector <code>c("times","fit","call")</code>.</p></dd>
</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list with elements depending on argument <code>keep</code>.</p>
<dl><dt>times</dt>
<dd><p>The times at which weights are estimated</p></dd>
<dt>IPCW.times</dt>
<dd><p>Estimated weights at <code>times</code></p></dd>
<dt>IPCW.subject.times</dt>
<dd><p>Estimated weights at individual time values
<code>subject.times</code></p></dd>
<dt>fit</dt>
<dd><p>The fitted censoring model</p></dd>
<dt>method</dt>
<dd><p>The method for modelling the censoring distribution</p></dd>
<dt>call</dt>
<dd><p>The call</p></dd>
</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Inverse of the probability of censoring weights (IPCW) usually refer to the
probabilities of not being censored at certain time points. These
probabilities are also the values of the conditional survival function of
the censoring time given covariates. The function ipcw estimates the
conditional survival function of the censoring times and derives the
weights.</p>
<p>IMPORTANT: the data set should be ordered, <code>order(time,-status)</code> in
order to get the values <code>IPCW.subject.times</code> in the right order for some
choices of <code>method</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Thomas A. Gerds <a href="mailto:tag@biostat.ku.dk">tag@biostat.ku.dk</a></p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"></span>
<span class="r-in"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">prodlim</span><span class="op">)</span></span>
<span class="r-in"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hbiostat.org/R/rms/" class="external-link">rms</a></span><span class="op">)</span></span>
<span class="r-in"><span class="va">dat</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/prodlim/man/SimSurv.html" class="external-link">SimSurv</a></span><span class="op">(</span><span class="fl">30</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">order</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">time</span><span class="op">)</span>,<span class="op">]</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># using the marginal Kaplan-Meier for the censoring times</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">WKM</span><span class="op">=</span><span class="fu">ipcw</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/prodlim/man/Hist.html" class="external-link">Hist</a></span><span class="op">(</span><span class="va">time</span>,<span class="va">status</span><span class="op">)</span><span class="op">~</span><span class="va">X2</span>,</span>
<span class="r-in">  data<span class="op">=</span><span class="va">dat</span>,</span>
<span class="r-in">  method<span class="op">=</span><span class="st">"marginal"</span>,</span>
<span class="r-in">  times<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>,</span>
<span class="r-in">  subject.times<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">time</span>,keep<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fit"</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">WKM</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span></span>
<span class="r-in"><span class="va">WKM</span><span class="op">$</span><span class="va">fit</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call: prodlim::prodlim(formula = formula, data = data, reverse = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Kaplan-Meier estimator for the censoring time survival function</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> No covariates</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Right-censored response of a survival model</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> No.Observations: 30 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Pattern:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 Freq</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  event          17  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  right.censored 13  </span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># using the Cox model for the censoring times given X2</span></span>
<span class="r-in"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span class="r-in"><span class="va">WCox</span><span class="op">=</span><span class="fu">ipcw</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/prodlim/man/Hist.html" class="external-link">Hist</a></span><span class="op">(</span>time<span class="op">=</span><span class="va">time</span>,event<span class="op">=</span><span class="va">status</span><span class="op">)</span><span class="op">~</span><span class="va">X2</span>,</span>
<span class="r-in">  data<span class="op">=</span><span class="va">dat</span>,</span>
<span class="r-in">  method<span class="op">=</span><span class="st">"cox"</span>,</span>
<span class="r-in">  times<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>,</span>
<span class="r-in">  subject.times<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">time</span>,keep<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fit"</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"><span class="va">WCox</span><span class="op">$</span><span class="va">fit</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Cox Proportional Hazards Model</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  (function (formula = formula(data), data = environment(formula), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      weights, subset, na.action = na.delete, method = c("efron", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          "breslow", "exact", "model.frame", "model.matrix"), singular.ok = FALSE, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      robust = FALSE, model = FALSE, x = FALSE, y = FALSE, se.fit = FALSE, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      linear.predictors = TRUE, residuals = TRUE, nonames = FALSE, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      eps = 1e-04, init, iter.max = 10, tol = 1e-09, surv = FALSE, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      time.inc, type = NULL, vartype = NULL, debug = FALSE, ...) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      method &lt;- match.arg(method)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      call &lt;- match.call()</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (!inherits(formula, "formula")) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (inherits(formula, "Surv")) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              xx &lt;- function(x) formula(x)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              formula &lt;- xx(paste(deparse(substitute(formula)), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  1, sep = "~"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          else stop("Invalid formula")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      callenv &lt;- parent.frame()</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      weights &lt;- if (!missing(weights)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          eval(substitute(weights), data, callenv)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      subset &lt;- if (!missing(subset)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          eval(substitute(subset), data, callenv)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      data &lt;- modelData(data, formula, weights = weights, subset = subset, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          na.action = na.action, dotexpand = FALSE, callenv = callenv)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      nstrata &lt;- 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      Strata &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      odb &lt;- .Options$debug</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (length(odb) &amp;&amp; is.logical(odb) &amp;&amp; odb) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          debug &lt;- TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (length(z &lt;- attr(terms(formula, allowDotAsName = TRUE), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          "term.labels")) &gt; 0 &amp;&amp; any(z != ".")) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          X &lt;- Design(data, formula, specials = c("strat", "strata"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          atrx &lt;- attributes(X)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          atr &lt;- atrx$Design</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          nact &lt;- atrx$na.action</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          sformula &lt;- atrx$sformula</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          mmcolnames &lt;- atr$mmcolnames</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (method == "model.frame") </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              return(X)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          Terms &lt;- terms(sformula, specials = c("strat", "strata"), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              data = data)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          asm &lt;- atr$assume.code</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          name &lt;- atr$name</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          specials &lt;- attr(Terms, "specials")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (length(specials$strata)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              stop("cph supports strat(), not strata()")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          stra &lt;- specials$strat</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          cluster &lt;- attr(X, "cluster")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (length(cluster)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              if (missing(robust)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  robust &lt;- TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              attr(X, "cluster") &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          Terms.ns &lt;- Terms</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (length(stra)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              temp &lt;- untangle.specials(Terms.ns, "strat", 1)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              Terms.ns &lt;- Terms.ns[-temp$terms]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              Strata &lt;- list()</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              strataname &lt;- attr(Terms, "term.labels")[stra - 1]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              j &lt;- 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              for (i in (1:length(asm))[asm == 8]) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  nstrata &lt;- nstrata + 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  xi &lt;- X[[i + 1]]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  levels(xi) &lt;- paste(name[i], "=", levels(xi), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    sep = "")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  Strata[[nstrata]] &lt;- xi</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              Strata &lt;- interaction(as.data.frame(Strata), drop = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          xpres &lt;- length(asm) &amp;&amp; any(asm != 8)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          Y &lt;- model.extract(X, "response")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (!inherits(Y, "Surv")) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              stop("response variable should be a Surv object")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          n &lt;- nrow(Y)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          weights &lt;- model.extract(X, "weights")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          offset &lt;- attr(X, "offset")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (!xpres) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              X &lt;- matrix(nrow = 0, ncol = 0)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              assign &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              X &lt;- model.matrix(sformula, X)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              alt &lt;- attr(mmcolnames, "alt")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              if (debug) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  print(cbind(`colnames(X)` = colnames(X)[-1], </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    mmcolnames = mmcolnames, `Design colnames` = atr$colnames, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    alt = alt))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              if (!all(mmcolnames %in% colnames(X)) &amp;&amp; length(alt)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  mmcolnames &lt;- alt</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              X &lt;- X[, mmcolnames, drop = FALSE]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              assign &lt;- attr(X, "assign")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              assign[[1]] &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          nullmod &lt;- FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          X &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          Y &lt;- data[[1]]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          sformula &lt;- formula</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          mmcolnames &lt;- ""</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          weights &lt;- if ("(weights)" %in% names(data)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              data[["(weights)"]]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          atr &lt;- atrx &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          Terms &lt;- terms(formula, allowDotAsName = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (!inherits(Y, "Surv")) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              stop("response variable should be a Surv object")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          Y &lt;- Y[!is.na(Y)]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          assign &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          xpres &lt;- FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          nullmod &lt;- TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          nact &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      ny &lt;- ncol(Y)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      maxtime &lt;- max(Y[, ny - 1])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      rnam &lt;- if (!nonames) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          dimnames(Y)[[1]]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (xpres) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          dimnames(X) &lt;- list(rnam, atr$colnames)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (method == "model.matrix") </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          return(X)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      time.units &lt;- units(Y)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (!length(time.units) || time.units == "") </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          time.units &lt;- "Day"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (missing(time.inc)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          time.inc &lt;- switch(time.units, Day = 30, Month = 1, Year = 1, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              maxtime/10)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (time.inc &gt;= maxtime | maxtime/time.inc &gt; 25) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              time.inc &lt;- max(pretty(c(0, maxtime)))/10</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      ytype &lt;- attr(Y, "type")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (nullmod) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          f &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          fitter &lt;- if (method == "breslow" || method == "efron") {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              if (ytype == "right") </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  coxph.fit</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              else agreg.fit</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          else if (method == "exact") {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              if (ytype == "right") </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  getFromNamespace("coxexact.fit", "survival")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              else agexact.fit</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          else stop(paste("Unknown method", method))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (missing(init)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              init &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          f &lt;- fitter(X, Y, strata = Strata, offset = offset, weights = weights, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              init = init, method = method, rownames = rnam, control = coxph.control(eps = eps, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  toler.chol = tol, toler.inf = 1, iter.max = iter.max))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (is.character(f)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          cat("Failure in cph:\n", f, "\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          return(structure(list(fail = TRUE), class = "cph"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (length(f$coefficients) &amp;&amp; any(is.na(f$coefficients))) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              vars &lt;- names(f$coefficients)[is.na(f$coefficients)]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              msg &lt;- paste("X matrix deemed to be singular; variable", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  paste(vars, collapse = " "))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              if (singular.ok) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  warning(msg)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  cat(msg, "\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  return(structure(list(fail = TRUE), class = "cph"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      f$terms &lt;- Terms</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      f$sformula &lt;- sformula</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      f$mmcolnames &lt;- mmcolnames</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (robust) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          f$naive.var &lt;- f$var</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (!length(cluster)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              cluster &lt;- FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          fit2 &lt;- c(f, list(x = X, y = Y, weights = weights, method = method))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (length(stra)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              fit2$strata &lt;- Strata</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          r &lt;- getS3method("residuals", "coxph")(fit2, type = "dfbeta", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              collapse = cluster, weighted = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          f$var &lt;- t(r) %*% r</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      nvar &lt;- length(f$coefficients)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      ev &lt;- factor(Y[, ny], levels = 0:1, labels = c("No Event", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          "Event"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      n.table &lt;- {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (!length(Strata)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              table(ev, dnn = "Status")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          else table(Strata, ev, dnn = c("Stratum", "Status"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      f$n &lt;- n.table</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      nevent &lt;- sum(Y[, ny])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (xpres) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          logtest &lt;- -2 * (f$loglik[1] - f$loglik[2])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          R2.max &lt;- 1 - exp(2 * f$loglik[1]/n)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          R2 &lt;- (1 - exp(-logtest/n))/R2.max</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          P &lt;- 1 - pchisq(logtest, nvar)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          gindex &lt;- GiniMd(f$linear.predictors)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          dxy &lt;- dxy.cens(f$linear.predictors, Y, type = "hazard")["Dxy"]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          stats &lt;- c(n, nevent, logtest, nvar, P, f$score, 1 - </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              pchisq(f$score, nvar), R2, dxy, gindex, exp(gindex))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          names(stats) &lt;- c("Obs", "Events", "Model L.R.", "d.f.", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              "P", "Score", "Score P", "R2", "Dxy", "g", "gr")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          stats &lt;- c(n, nevent)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          names(stats) &lt;- c("Obs", "Events")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      f$method &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (xpres) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          dimnames(f$var) &lt;- list(atr$colnames, atr$colnames)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      f &lt;- c(f, list(call = call, Design = atr, assign = DesignAssign(atr, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          0, atrx$terms), na.action = nact, fail = FALSE, non.slopes = 0, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          stats = stats, method = method, maxtime = maxtime, time.inc = time.inc, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          units = time.units))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (xpres) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          f$center &lt;- sum(f$means * f$coefficients)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          f$scale.pred &lt;- c("log Relative Hazard", "Hazard Ratio")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          attr(f$linear.predictors, "strata") &lt;- Strata</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          names(f$linear.predictors) &lt;- rnam</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (se.fit) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              XX &lt;- X - rep(f$means, rep.int(n, nvar))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              se.fit &lt;- drop(((XX %*% f$var) * XX) %*% rep(1, ncol(XX)))^0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              names(se.fit) &lt;- rnam</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              f$se.fit &lt;- se.fit</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (model) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          f$model &lt;- data</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (is.character(surv) || surv) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (length(Strata)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              iStrata &lt;- as.character(Strata)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              slev &lt;- levels(Strata)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              nstr &lt;- length(slev)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          else nstr &lt;- 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          srv &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          tim &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          s.e. &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          timepts &lt;- seq(0, maxtime, by = time.inc)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          s.sum &lt;- array(double(1), c(length(timepts), nstr, 3), </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              list(format(timepts), paste("Stratum", 1:nstr), c("Survival", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  "n.risk", "std.err")))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          g &lt;- list(n = sum(f$n), coefficients = f$coefficients, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              linear.predictors = f$linear.predictors, method = f$method, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              type = type, means = f$means, var = f$var, x = X, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              y = Y, strata = Strata, offset = offset, weights = weights, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              terms = Terms, call = call)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          g &lt;- survfit.cph(g, se.fit = is.character(surv) || surv, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              type = type, vartype = vartype, conf.type = "log")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          strt &lt;- if (nstr &gt; 1) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              rep(names(g$strata), g$strata)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          for (k in 1:nstr) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              j &lt;- if (nstr == 1) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              else strt == slev[k]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              yy &lt;- Y[if (nstr == 1) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              else iStrata == slev[k], ny - 1]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              maxt &lt;- max(yy)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              tt &lt;- c(0, g$time[j])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              su &lt;- c(1, g$surv[j])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              se &lt;- c(NA, g$std.err[j])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              if (maxt &gt; tt[length(tt)]) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  tt &lt;- c(tt, maxt)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  su &lt;- c(su, su[length(su)])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  se &lt;- c(se, NA)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              kk &lt;- 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              for (tp in timepts) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  kk &lt;- kk + 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  t.choice &lt;- max((1:length(tt))[tt &lt;= tp + 1e-06])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  if (tp &gt; max(tt) + 1e-06 &amp; su[length(su)] &gt; 0) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    Su &lt;- NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    Se &lt;- NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    Su &lt;- su[t.choice]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    Se &lt;- se[t.choice]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  n.risk &lt;- sum(yy &gt;= tp)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  s.sum[kk, k, 1:3] &lt;- c(Su, n.risk, Se)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              if (!is.character(surv)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  if (nstr == 1) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    tim &lt;- tt</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    srv &lt;- su</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    s.e. &lt;- se</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    tim &lt;- c(tim, list(tt))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    srv &lt;- c(srv, list(su))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    s.e. &lt;- c(s.e., list(se))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          if (is.character(surv)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              f$surv.summary &lt;- s.sum</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              if (nstr &gt; 1) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  names(srv) &lt;- names(tim) &lt;- names(s.e.) &lt;- levels(Strata)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              f &lt;- c(f, list(time = tim, surv = srv, std.err = s.e., </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                  surv.summary = s.sum))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      f$strata &lt;- Strata</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (x) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          f$x &lt;- X</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (y) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          f$y &lt;- Y</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      f$weights &lt;- weights</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      f$offset &lt;- offset</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (!linear.predictors) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          f$linear.predictors &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      if (!residuals) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          f$residuals &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      class(f) &lt;- c("cph", "rms", "coxph")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      f</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  })(formula = Surv(time, status) ~ X2, data = structure(list(time = c(0.485624671863262, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1.26409376042954, 1.33666658193828, 1.8876406134119, 2.31585909834859, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  2.53142323120341, 2.67405539887999, 2.69682636249489, 3.04496515034811, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  3.33099029359641, 3.45667132868933, 3.6604107498161, 3.9366262675404, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  4.23594158088559, 4.34869495838047, 4.43144745795761, 4.4598771336945, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  4.68239441160373, 5.06756240443228, 6.36681483353204, 6.46626318654265, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  7.12297337435571, 7.30485475634867, 7.34387535566165, 7.56803748444143, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  7.62294895297476, 8.4923916991555, 8.82720753717643, 11.9858149603988, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  14.6952284599549), status = c(1, 1, 0, 1, 0, 0, 0, 1, 1, 0, 0, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1), X2 = c(0.737784077209451, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  0.208242935671302, -0.0857343344820172, -1.17625414199995, 0.134013692019997, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  0.88812084100851, 0.761534674446218, -0.230798720053901, -0.551165311562187, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  0.0203205955518868, 1.15478690980615, 2.06122996814056, -1.23681891186452, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1.50293414722451, 0.806509249150504, 0.670331809310477, -1.29286800723766, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  0.441911199605587, -0.920611029980694, 0.427200660684708, 1.43374439008612, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  -0.92076145785956, -2.09617436394711, -0.310693352821634, 0.310154484013825, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  0.250866817041062, -0.0648836508035696, -0.145929333271849, -0.839686914881022, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  -0.179535721967552)), row.names = c("27", "9", "11", "12", "26", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  "21", "5", "28", "3", "4", "22", "7", "18", "6", "24", "14", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  "17", "1", "8", "16", "23", "25", "13", "15", "30", "2", "19", </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  "29", "10", "20"), class = "data.frame"), x = TRUE, y = TRUE, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      eps = 1e-06, surv = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                          Model Tests    Discrimination    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                                                Indexes    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Obs         30    LR chi2      3.41    R2       0.123    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Events      13    d.f.            1    Dxy      0.253    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Center -0.0369    Pr(&gt; chi2) 0.0648    g        0.674    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    Score chi2   3.52    gr       1.962    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    Pr(&gt; chi2) 0.0606                      </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Coef    S.E.   Wald Z Pr(&gt;|Z|)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  X2 -0.6300 0.3394 -1.86  0.0634  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  </span>
<span class="r-in"></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">WKM</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>,</span>
<span class="r-in">      <span class="fl">1</span><span class="op">-</span><span class="va">WCox</span><span class="op">$</span><span class="va">IPCW.times</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>,</span>
<span class="r-in">      type<span class="op">=</span><span class="st">"l"</span>,</span>
<span class="r-in">      col<span class="op">=</span><span class="fl">2</span>,</span>
<span class="r-in">      lty<span class="op">=</span><span class="fl">3</span>,</span>
<span class="r-in">      lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>,</span>
<span class="r-in">      <span class="fl">1</span><span class="op">-</span><span class="va">WCox</span><span class="op">$</span><span class="va">IPCW.times</span><span class="op">[</span><span class="fl">5</span>,<span class="op">]</span>,</span>
<span class="r-in">      type<span class="op">=</span><span class="st">"l"</span>,</span>
<span class="r-in">      col<span class="op">=</span><span class="fl">3</span>,</span>
<span class="r-in">      lty<span class="op">=</span><span class="fl">3</span>,</span>
<span class="r-in">      lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span class="r-plt img"><img src="ipcw-1.png" alt="" width="700" height="433"></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># using the stratified Kaplan-Meier</span></span>
<span class="r-in"><span class="co"># for the censoring times given X2</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">WKM2</span><span class="op">=</span><span class="fu">ipcw</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/prodlim/man/Hist.html" class="external-link">Hist</a></span><span class="op">(</span><span class="va">time</span>,<span class="va">status</span><span class="op">)</span><span class="op">~</span><span class="va">X2</span>,</span>
<span class="r-in">  data<span class="op">=</span><span class="va">dat</span>,</span>
<span class="r-in">  method<span class="op">=</span><span class="st">"nonpar"</span>,</span>
<span class="r-in">  times<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>,</span>
<span class="r-in">  subject.times<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">time</span>,keep<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fit"</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">WKM2</span><span class="op">$</span><span class="va">fit</span>,add<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span class="r-plt img"><img src="ipcw-2.png" alt="" width="700" height="433"></span>
<span class="r-in"></span>
<span class="r-in"></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Thomas Alexander Gerds, Johan Sebastian Ohlendorff, Brice Ozenne.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer></div>

  

  

  </body></html>

