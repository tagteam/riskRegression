<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="This function is used internally to contruct pseudo values by inverse of the
probability of censoring weights."><title>Estimation of censoring probabilities at subject specific times — subjectWeights • riskRegression</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimation of censoring probabilities at subject specific times — subjectWeights"><meta property="og:description" content="This function is used internally to contruct pseudo values by inverse of the
probability of censoring weights."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">riskRegression</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2022.03.08</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/tagteam/riskRegression/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Estimation of censoring probabilities at subject specific times</h1>
      <small class="dont-index">Source: <a href="https://github.com/tagteam/riskRegression/blob/HEAD/R/subjectWeights.R" class="external-link"><code>R/subjectWeights.R</code></a></small>
      <div class="d-none name"><code>subjectWeights.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function is used internally to contruct pseudo values by inverse of the
probability of censoring weights.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="fu">subjectWeights</span><span class="op">(</span>
  <span class="va">formula</span>,
  <span class="va">data</span>,
  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cox"</span>, <span class="st">"marginal"</span>, <span class="st">"km"</span>, <span class="st">"nonpar"</span>, <span class="st">"forest"</span>, <span class="st">"none"</span><span class="op">)</span>,
  <span class="va">args</span>,
  lag <span class="op">=</span> <span class="fl">1</span>
<span class="op">)</span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>formula</dt>
<dd><p>A survival formula like, Surv(time,status)~1 or
Hist(time,status)~1 where status=0 means censored. The status
variable is internally reversed for estimation of censoring rather
than survival probabilities. Some of the available models, see
argument <code>model</code>, will use predictors on the right hand side
of the formula.</p></dd>
<dt>data</dt>
<dd><p>The data used for fitting the censoring model</p></dd>
<dt>method</dt>
<dd><p>Censoring model used for estimation of the
(conditional) censoring distribution.</p></dd>
<dt>args</dt>
<dd><p>Arguments passed to the fitter of the method.</p></dd>
<dt>lag</dt>
<dd><p>If equal to <code>1</code> then obtain <code>G(T_i-|X_i)</code>, if
equal to <code>0</code> estimate the conditional censoring distribution
at the subject.times, i.e. (<code>G(T_i|X_i)</code>).</p></dd>
</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <dl><dt>times</dt>
<dd><p>The times at which weights are estimated</p></dd>
<dt>weights</dt>
<dd><p>Estimated weights at individual time values
<code>subject.times</code></p></dd>
<dt>lag</dt>
<dd><p>The time lag.</p></dd>
<dt>fit</dt>
<dd><p>The fitted
censoring model</p></dd>
<dt>method</dt>
<dd><p>The method for modelling the censoring
distribution</p></dd>
<dt>call</dt>
<dd><p>The call</p></dd>
</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Inverse of the probability of censoring weights usually refer to the
probabilities of not being censored at certain time points. These
probabilities are also the values of the conditional survival function of
the censoring time given covariates. The function subjectWeights estimates
the conditional survival function of the censoring times and derives the
weights.</p>
<p>IMPORTANT: the data set should be ordered, <code>order(time,-status)</code> in
order to get the <code>weights</code> in the right order for some choices of
<code>method</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Thomas A. Gerds <a href="mailto:tag@biostat.ku.dk">tag@biostat.ku.dk</a></p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"></span>
<span class="r-in"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">prodlim</span><span class="op">)</span></span>
<span class="r-in"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span class="r-in"><span class="va">dat</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/prodlim/man/SimSurv.html" class="external-link">SimSurv</a></span><span class="op">(</span><span class="fl">300</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">order</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">time</span>,<span class="op">-</span><span class="va">dat</span><span class="op">$</span><span class="va">status</span><span class="op">)</span>,<span class="op">]</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># using the marginal Kaplan-Meier for the censoring times</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">WKM</span><span class="op">=</span><span class="fu">subjectWeights</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/prodlim/man/Hist.html" class="external-link">Hist</a></span><span class="op">(</span><span class="va">time</span>,<span class="va">status</span><span class="op">)</span><span class="op">~</span><span class="va">X2</span>,data<span class="op">=</span><span class="va">dat</span>,method<span class="op">=</span><span class="st">"marginal"</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">WKM</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span></span>
<span class="r-plt img"><img src="subjectWeights-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span class="va">WKM</span><span class="op">$</span><span class="va">fit</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call: prodlim::prodlim(formula = formula, data = data, reverse = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Kaplan-Meier estimator for the censoring time survival function</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> No covariates</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Right-censored response of a survival model</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> No.Observations: 300 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Pattern:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 Freq</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  event          172 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  right.censored 128 </span>
<span class="r-in"><span class="va">WKM</span><span class="op">$</span><span class="va">weights</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [1] 1.00000000 1.00000000 1.00000000 1.00000000 0.99663300 0.99663300</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   [7] 0.99663300 0.99663300 0.99663300 0.99321987 0.99321987 0.98979497</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [13] 0.98979497 0.98635819 0.98292140 0.97948461 0.97604782 0.97604782</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [19] 0.97604782 0.97604782 0.97604782 0.97604782 0.97604782 0.97604782</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [25] 0.97604782 0.97604782 0.97604782 0.97604782 0.97247255 0.96889729</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [31] 0.96889729 0.96889729 0.96889729 0.96889729 0.96889729 0.96525482</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [37] 0.96161235 0.96161235 0.95795603 0.95795603 0.95795603 0.95427158</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [43] 0.95058713 0.95058713 0.95058713 0.95058713 0.95058713 0.95058713</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [49] 0.95058713 0.95058713 0.95058713 0.95058713 0.95058713 0.95058713</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [55] 0.94673860 0.94673860 0.94673860 0.94673860 0.94673860 0.94673860</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [61] 0.94673860 0.94673860 0.94277735 0.94277735 0.93879939 0.93879939</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [67] 0.93480450 0.93480450 0.93480450 0.93077517 0.93077517 0.92672832</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [73] 0.92268147 0.92268147 0.92268147 0.92268147 0.92268147 0.92268147</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [79] 0.92268147 0.92268147 0.91850644 0.91850644 0.91850644 0.91850644</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [85] 0.91850644 0.91850644 0.91850644 0.91421436 0.91421436 0.91421436</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [91] 0.91421436 0.90986095 0.90550755 0.90550755 0.90550755 0.90550755</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [97] 0.90550755 0.90106879 0.90106879 0.90106879 0.90106879 0.89656345</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [103] 0.89656345 0.89656345 0.89656345 0.89656345 0.89196568 0.89196568</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [109] 0.88734410 0.88734410 0.88734410 0.88734410 0.88734410 0.88734410</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [115] 0.88259895 0.88259895 0.88259895 0.87780221 0.87780221 0.87780221</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [121] 0.87780221 0.87780221 0.87780221 0.87287074 0.87287074 0.86791125</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [127] 0.86295175 0.85799226 0.85303277 0.85303277 0.85303277 0.85303277</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [133] 0.85303277 0.85303277 0.84792479 0.84281681 0.84281681 0.84281681</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [139] 0.84281681 0.84281681 0.84281681 0.84281681 0.83751607 0.83751607</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [145] 0.83218157 0.83218157 0.83218157 0.83218157 0.82674248 0.82674248</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [151] 0.82126736 0.81579225 0.81579225 0.81028014 0.81028014 0.80473027</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [157] 0.80473027 0.80473027 0.80473027 0.80473027 0.80473027 0.80473027</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [163] 0.80473027 0.80473027 0.79885633 0.79885633 0.79885633 0.79885633</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [169] 0.79284989 0.78684345 0.78684345 0.78079081 0.77473817 0.76868553</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [175] 0.76263288 0.75658024 0.75052760 0.74447496 0.74447496 0.73837271</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [181] 0.73227045 0.72616820 0.72006594 0.71396369 0.71396369 0.70780883</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [187] 0.70165397 0.70165397 0.70165397 0.70165397 0.69533276 0.68901156</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [193] 0.68901156 0.68901156 0.68257220 0.68257220 0.67607151 0.67607151</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [199] 0.66950771 0.66950771 0.66287892 0.66287892 0.65618317 0.64948743</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [205] 0.64279168 0.64279168 0.64279168 0.64279168 0.64279168 0.63580481</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [211] 0.62881795 0.62881795 0.62175258 0.61468721 0.60762184 0.60762184</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [217] 0.60047334 0.59332485 0.58617636 0.57902787 0.57902787 0.57902787</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [223] 0.57902787 0.57160443 0.56418100 0.55675757 0.54933413 0.54191070</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [229] 0.53448726 0.53448726 0.52695927 0.51943128 0.51943128 0.51179259</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [235] 0.50415389 0.50415389 0.49639768 0.48864147 0.48088525 0.47312904</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [241] 0.46537282 0.46537282 0.45748515 0.45748515 0.44945909 0.44143304</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [247] 0.43340698 0.43340698 0.43340698 0.42507223 0.41673748 0.41673748</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [253] 0.40823264 0.40823264 0.40823264 0.40823264 0.39916080 0.39008896</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [259] 0.39008896 0.39008896 0.38057460 0.38057460 0.38057460 0.37055948</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [265] 0.36054436 0.35052924 0.35052924 0.35052924 0.35052924 0.33957520</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [271] 0.32862116 0.32862116 0.31728940 0.31728940 0.31728940 0.31728940</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [277] 0.30459782 0.30459782 0.29135444 0.27811105 0.26486767 0.25162429</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [283] 0.25162429 0.23764516 0.23764516 0.22279234 0.22279234 0.22279234</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [289] 0.20565446 0.20565446 0.18695860 0.16826274 0.16826274 0.14722990</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [295] 0.12619706 0.10516421 0.10516421 0.07887316 0.05258211 0.02629105</span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># using the Cox model for the censoring times given X2</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">WCox</span><span class="op">=</span><span class="fu">subjectWeights</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>,<span class="va">status</span><span class="op">)</span><span class="op">~</span><span class="va">X2</span>,data<span class="op">=</span><span class="va">dat</span>,method<span class="op">=</span><span class="st">"cox"</span><span class="op">)</span></span>
<span class="r-in"><span class="va">WCox</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Estimated inverse of the probability of censoring weights (subjectWeights)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Method for estimation:  Cox regression </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Handler function:  function (formula = formula(data), data = environment(formula), weights, subset, na.action = na.delete, method = c("efron", "breslow", "exact", "model.frame", "model.matrix"), singular.ok = FALSE, robust = FALSE, model = FALSE, x = FALSE, y = FALSE, se.fit = FALSE, linear.predictors = TRUE, residuals = TRUE, nonames = FALSE, eps = 1e-04, init, iter.max = 10, tol = 1e-09, surv = FALSE, time.inc, type = NULL, vartype = NULL, debug = FALSE, ...) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     method &lt;- match.arg(method)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     call &lt;- match.call()</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (!inherits(formula, "formula")) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (inherits(formula, "Surv")) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             xx &lt;- function(x) formula(x)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             formula &lt;- xx(paste(deparse(substitute(formula)), 1, sep = "~"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         else stop("Invalid formula")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     callenv &lt;- parent.frame()</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     weights &lt;- if (!missing(weights)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         eval(substitute(weights), data, callenv)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     subset &lt;- if (!missing(subset)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         eval(substitute(subset), data, callenv)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     data &lt;- modelData(data, formula, weights = weights, subset = subset, na.action = na.action, dotexpand = FALSE, callenv = callenv)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     nstrata &lt;- 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Strata &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     odb &lt;- .Options$debug</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (length(odb) &amp;&amp; is.logical(odb) &amp;&amp; odb) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         debug &lt;- TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (length(z &lt;- attr(terms(formula, allowDotAsName = TRUE), "term.labels")) &gt; 0 &amp;&amp; any(z != ".")) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         X &lt;- Design(data, formula, specials = c("strat", "strata"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         atrx &lt;- attributes(X)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         atr &lt;- atrx$Design</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nact &lt;- atrx$na.action</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         sformula &lt;- atrx$sformula</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         mmcolnames &lt;- atr$mmcolnames</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (method == "model.frame") </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             return(X)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         Terms &lt;- terms(sformula, specials = c("strat", "strata"), data = data)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         asm &lt;- atr$assume.code</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         name &lt;- atr$name</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         specials &lt;- attr(Terms, "specials")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (length(specials$strata)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             stop("cph supports strat(), not strata()")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         stra &lt;- specials$strat</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         cluster &lt;- attr(X, "cluster")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (length(cluster)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (missing(robust)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 robust &lt;- TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             attr(X, "cluster") &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         Terms.ns &lt;- Terms</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (length(stra)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             temp &lt;- untangle.specials(Terms.ns, "strat", 1)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             Terms.ns &lt;- Terms.ns[-temp$terms]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             Strata &lt;- list()</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             strataname &lt;- attr(Terms, "term.labels")[stra - 1]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             j &lt;- 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             for (i in (1:length(asm))[asm == 8]) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 nstrata &lt;- nstrata + 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 xi &lt;- X[[i + 1]]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 levels(xi) &lt;- paste(name[i], "=", levels(xi), sep = "")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 Strata[[nstrata]] &lt;- xi</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             Strata &lt;- interaction(as.data.frame(Strata), drop = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         xpres &lt;- length(asm) &amp;&amp; any(asm != 8)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         Y &lt;- model.extract(X, "response")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (!inherits(Y, "Surv")) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             stop("response variable should be a Surv object")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         n &lt;- nrow(Y)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         weights &lt;- model.extract(X, "weights")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         offset &lt;- attr(X, "offset")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (!xpres) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             X &lt;- matrix(nrow = 0, ncol = 0)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             assign &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             X &lt;- model.matrix(sformula, X)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             alt &lt;- attr(mmcolnames, "alt")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (debug) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 print(cbind(`colnames(X)` = colnames(X)[-1], mmcolnames = mmcolnames, `Design colnames` = atr$colnames, alt = alt))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (!all(mmcolnames %in% colnames(X)) &amp;&amp; length(alt)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 mmcolnames &lt;- alt</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             X &lt;- X[, mmcolnames, drop = FALSE]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             assign &lt;- attr(X, "assign")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             assign[[1]] &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nullmod &lt;- FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         X &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         Y &lt;- data[[1]]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         sformula &lt;- formula</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         mmcolnames &lt;- ""</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         weights &lt;- if ("(weights)" %in% names(data)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             data[["(weights)"]]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         atr &lt;- atrx &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         Terms &lt;- terms(formula, allowDotAsName = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (!inherits(Y, "Surv")) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             stop("response variable should be a Surv object")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         Y &lt;- Y[!is.na(Y)]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         assign &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         xpres &lt;- FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nullmod &lt;- TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         nact &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ny &lt;- ncol(Y)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     maxtime &lt;- max(Y[, ny - 1])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     rnam &lt;- if (!nonames) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         dimnames(Y)[[1]]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (xpres) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         dimnames(X) &lt;- list(rnam, atr$colnames)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (method == "model.matrix") </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         return(X)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     time.units &lt;- units(Y)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (!length(time.units) || time.units == "") </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         time.units &lt;- "Day"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (missing(time.inc)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         time.inc &lt;- switch(time.units, Day = 30, Month = 1, Year = 1, maxtime/10)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (time.inc &gt;= maxtime | maxtime/time.inc &gt; 25) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             time.inc &lt;- max(pretty(c(0, maxtime)))/10</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ytype &lt;- attr(Y, "type")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (nullmod) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         f &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         fitter &lt;- if (method == "breslow" || method == "efron") {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (ytype == "right") </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 coxph.fit</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             else agreg.fit</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         else if (method == "exact") {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (ytype == "right") </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 getFromNamespace("coxexact.fit", "survival")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             else agexact.fit</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         else stop(paste("Unknown method", method))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (missing(init)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             init &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         f &lt;- fitter(X, Y, strata = Strata, offset = offset, weights = weights, init = init, method = method, rownames = rnam, control = coxph.control(eps = eps, toler.chol = tol, toler.inf = 1, iter.max = iter.max))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (is.character(f)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         cat("Failure in cph:\n", f, "\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         return(structure(list(fail = TRUE), class = "cph"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (length(f$coefficients) &amp;&amp; any(is.na(f$coefficients))) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             vars &lt;- names(f$coefficients)[is.na(f$coefficients)]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             msg &lt;- paste("X matrix deemed to be singular; variable", paste(vars, collapse = " "))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (singular.ok) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 warning(msg)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 cat(msg, "\n")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 return(structure(list(fail = TRUE), class = "cph"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     f$terms &lt;- Terms</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     f$sformula &lt;- sformula</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     f$mmcolnames &lt;- mmcolnames</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (robust) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         f$naive.var &lt;- f$var</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (!length(cluster)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             cluster &lt;- FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         fit2 &lt;- c(f, list(x = X, y = Y, weights = weights, method = method))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (length(stra)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             fit2$strata &lt;- Strata</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         r &lt;- getS3method("residuals", "coxph")(fit2, type = "dfbeta", collapse = cluster, weighted = TRUE)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         f$var &lt;- t(r) %*% r</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     nvar &lt;- length(f$coefficients)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ev &lt;- factor(Y[, ny], levels = 0:1, labels = c("No Event", "Event"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     n.table &lt;- {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (!length(Strata)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             table(ev, dnn = "Status")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         else table(Strata, ev, dnn = c("Stratum", "Status"))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     f$n &lt;- n.table</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     nevent &lt;- sum(Y[, ny])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (xpres) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         logtest &lt;- -2 * (f$loglik[1] - f$loglik[2])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         R2.max &lt;- 1 - exp(2 * f$loglik[1]/n)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         R2 &lt;- (1 - exp(-logtest/n))/R2.max</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         P &lt;- 1 - pchisq(logtest, nvar)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         gindex &lt;- GiniMd(f$linear.predictors)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         dxy &lt;- dxy.cens(f$linear.predictors, Y, type = "hazard")["Dxy"]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         stats &lt;- c(n, nevent, logtest, nvar, P, f$score, 1 - pchisq(f$score, nvar), R2, dxy, gindex, exp(gindex))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         names(stats) &lt;- c("Obs", "Events", "Model L.R.", "d.f.", "P", "Score", "Score P", "R2", "Dxy", "g", "gr")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         stats &lt;- c(n, nevent)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         names(stats) &lt;- c("Obs", "Events")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     f$method &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (xpres) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         dimnames(f$var) &lt;- list(atr$colnames, atr$colnames)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     f &lt;- c(f, list(call = call, Design = atr, assign = DesignAssign(atr, 0, atrx$terms), na.action = nact, fail = FALSE, non.slopes = 0, stats = stats, method = method, maxtime = maxtime, time.inc = time.inc, units = time.units))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (xpres) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         f$center &lt;- sum(f$means * f$coefficients)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         f$scale.pred &lt;- c("log Relative Hazard", "Hazard Ratio")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         attr(f$linear.predictors, "strata") &lt;- Strata</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         names(f$linear.predictors) &lt;- rnam</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (se.fit) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             XX &lt;- X - rep(f$means, rep.int(n, nvar))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             se.fit &lt;- drop(((XX %*% f$var) * XX) %*% rep(1, ncol(XX)))^0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             names(se.fit) &lt;- rnam</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             f$se.fit &lt;- se.fit</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (model) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         f$model &lt;- data</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (is.character(surv) || surv) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (length(Strata)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             iStrata &lt;- as.character(Strata)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             slev &lt;- levels(Strata)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             nstr &lt;- length(slev)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         else nstr &lt;- 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         srv &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         tim &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         s.e. &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         timepts &lt;- seq(0, maxtime, by = time.inc)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         s.sum &lt;- array(double(1), c(length(timepts), nstr, 3), list(format(timepts), paste("Stratum", 1:nstr), c("Survival", "n.risk", "std.err")))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         g &lt;- list(n = sum(f$n), coefficients = f$coefficients, linear.predictors = f$linear.predictors, method = f$method, type = type, means = f$means, var = f$var, x = X, y = Y, strata = Strata, offset = offset, weights = weights, terms = Terms, call = call)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         g &lt;- survfit.cph(g, se.fit = is.character(surv) || surv, type = type, vartype = vartype, conf.type = "log")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         strt &lt;- if (nstr &gt; 1) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             rep(names(g$strata), g$strata)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         for (k in 1:nstr) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             j &lt;- if (nstr == 1) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             else strt == slev[k]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             yy &lt;- Y[if (nstr == 1) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             else iStrata == slev[k], ny - 1]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             maxt &lt;- max(yy)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             tt &lt;- c(0, g$time[j])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             su &lt;- c(1, g$surv[j])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             se &lt;- c(NA, g$std.err[j])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (maxt &gt; tt[length(tt)]) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 tt &lt;- c(tt, maxt)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 su &lt;- c(su, su[length(su)])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 se &lt;- c(se, NA)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             kk &lt;- 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             for (tp in timepts) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 kk &lt;- kk + 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 t.choice &lt;- max((1:length(tt))[tt &lt;= tp + 1e-06])</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 if (tp &gt; max(tt) + 1e-06 &amp; su[length(su)] &gt; 0) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   Su &lt;- NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   Se &lt;- NA</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   Su &lt;- su[t.choice]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   Se &lt;- se[t.choice]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 n.risk &lt;- sum(yy &gt;= tp)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 s.sum[kk, k, 1:3] &lt;- c(Su, n.risk, Se)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (!is.character(surv)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 if (nstr == 1) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   tim &lt;- tt</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   srv &lt;- su</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   s.e. &lt;- se</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   tim &lt;- c(tim, list(tt))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   srv &lt;- c(srv, list(su))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   s.e. &lt;- c(s.e., list(se))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         if (is.character(surv)) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             f$surv.summary &lt;- s.sum</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         else {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             if (nstr &gt; 1) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                 names(srv) &lt;- names(tim) &lt;- names(s.e.) &lt;- levels(Strata)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>             f &lt;- c(f, list(time = tim, surv = srv, std.err = s.e., surv.summary = s.sum))</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     f$strata &lt;- Strata</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (x) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         f$x &lt;- X</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (y) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         f$y &lt;- Y</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     f$weights &lt;- weights</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     f$offset &lt;- offset</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (!linear.predictors) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         f$linear.predictors &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     if (!residuals) </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         f$residuals &lt;- NULL</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     class(f) &lt;- c("cph", "rms", "coxph")</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     f</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }() </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Summary of the weights  G(T_i-|X_i) :</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  0.0392  0.5643  0.8254  0.7273  0.9247  1.0000 </span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">WCox</span><span class="op">$</span><span class="va">weights</span>,<span class="va">WKM</span><span class="op">$</span><span class="va">weights</span><span class="op">)</span></span>
<span class="r-plt img"><img src="subjectWeights-2.png" alt="" width="700" height="433"></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># using the stratified Kaplan-Meier for the censoring times given X2</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">WKM2</span> <span class="op">&lt;-</span> <span class="fu">subjectWeights</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>,<span class="va">status</span><span class="op">)</span><span class="op">~</span><span class="va">X2</span>,data<span class="op">=</span><span class="va">dat</span>,method<span class="op">=</span><span class="st">"nonpar"</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">WKM2</span><span class="op">$</span><span class="va">fit</span>,add<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span class="r-plt img"><img src="subjectWeights-3.png" alt="" width="700" height="433"></span>
<span class="r-in"></span>
<span class="r-in"></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Thomas Alexander Gerds, Johan Sebastian Ohlendorff, Brice Ozenne.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer></div>

  

  

  </body></html>

