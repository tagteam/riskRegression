<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="riskRegression">
<title>Derivation of the Influence Function for AUC for competing risk data and survival data â€¢ riskRegression</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Derivation of the Influence Function for AUC for competing risk data and survival data">
<meta property="og:description" content="riskRegression">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">riskRegression</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2022.09.28</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/IFAUC.html">Derivation of the Influence Function for AUC for competing risk data and survival data</a>
    <a class="dropdown-item" href="../articles/IFBrier.html">Influence function calculation for Brier score for event time data</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/tagteam/riskRegression/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="IFAUC_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Derivation of the Influence Function for AUC for competing risk data and survival data</h1>
                        <h4 data-toc-skip class="author">Johan Sebastian Ohlendorff &amp; Thomas Alexander Gerds</h4>
            
            <h4 data-toc-skip class="date">2022-01-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/tagteam/riskRegression/blob/HEAD/vignettes/IFAUC.Rmd" class="external-link"><code>vignettes/IFAUC.Rmd</code></a></small>
      <div class="d-none name"><code>IFAUC.Rmd</code></div>
    </div>

    
    


<!-- for use with Rikkes paper -->

<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this document we derive the influence function of the inverse probability of censoring weighted (IPCW) estimator of the time-dependent AUC in the cases with and without competing risks. We denote the uncensored time to event by <span class="math inline">\(T\)</span>, the right censoring time by <span class="math inline">\(C\)</span>, and by <span class="math inline">\(X\)</span> a continuous marker. Let us first look at the case, where <span class="math inline">\(T\)</span> is not censored (and there is only one event).</p>
</div>
<div class="section level2">
<h2 id="influence-function-uncensored-case">Influence function uncensored case<a class="anchor" aria-label="anchor" href="#influence-function-uncensored-case"></a>
</h2>
<p>In the uncensored case, we observe <span class="math inline">\((T,X)\)</span> and denote <span class="math inline">\(Q\)</span> for the joint probability measure <span class="math inline">\(Q\)</span>, i.e., <span class="math inline">\((T,X) \sim Q\)</span>. The time-dependent AUC at time <span class="math inline">\(\tau\)</span> for marker <span class="math inline">\(X\)</span> is defined as: <span class="math display">\[
\ensuremath{\operatorname{AUC}}(\tau)=Q(X&gt;\ensuremath{X^{\prime}}| T \leq \tau, T^{\prime}&gt;\tau)=\frac{Q(T \leq \tau,
  T^{\prime}&gt;\tau, X&gt;\ensuremath{X^{\prime}})}{Q(T \leq \tau,
  T^{\prime}&gt;\tau)}
\]</span> Let <span class="math inline">\(\mathcal{Q}\)</span> be the set of all probability measures of <span class="math inline">\(T,X\)</span> and consider the functional <span class="math inline">\(\nu_{\tau}:\mathcal{Q}\to [0,1]\)</span> <span class="math display">\[
\nu_{\tau}(Q)=\int \int 1_{\{t \leq \tau, t^{\prime}&gt;\tau, x&gt;\ensuremath{x^{\prime}}\}} d Q(t, x) d Q (t^{\prime}, \ensuremath{x^{\prime}})
\]</span> Note that the value of the functional is the numerator of the : <span class="math display">\[
\nu_{\tau}(Q)=Q(T \leq \tau, T^{\prime}&gt;\tau, X&gt;\ensuremath{X^{\prime}})
\]</span> To derive the Gateaux derivative of the functional at <span class="math inline">\(Q\)</span> in the direction of an observation <span class="math inline">\(T_i,X_i\)</span> we introduce the corresponding path, <span class="math display">\[\begin{align*}
Q_{\varepsilon}^{i}=Q+\varepsilon\left\{\delta_{\left\{T_{i},
      X_i\right\}}-Q\right\}.
\intertext{and the following short notation
$\partial_{\varepsilon}=\left.\frac{\partial}{\partial
  \varepsilon}\right|_{\varepsilon=0}$ to obtain the directional derivative:}
 \partial_{\varepsilon} Q_{\varepsilon}^{i}=\delta_{\left\{T_{i}, X_i\right\}}-Q.
\end{align*}\]</span> The Gateaux derivative of the functional <span class="math inline">\(\nu_{\tau}\)</span> is obtained using straight-forward calculus: <span class="math display">\[\begin{align*}
  \partial_{\varepsilon} \nu_{\tau}(Q_{\varepsilon})&amp;=\int \int 1_{\{t \leq \tau, t^{\prime}&gt;\tau, x&gt;\ensuremath{x^{\prime}}\}} \partial_{\varepsilon} Q_{\varepsilon}^{i} (t,x) d Q (t^{\prime}, \ensuremath{x^{\prime}})\\
                                                      &amp;\quad + \int \int 1_{\{t \leq \tau, t^{\prime}&gt;\tau, x&gt;\ensuremath{x^{\prime}}\}} d Q(t, x) \partial_{\varepsilon} Q_{\varepsilon}^{i} (t^{\prime}, \ensuremath{x^{\prime}}) \\
&amp;= \int \int 1_{\{t \leq \tau, t^{\prime}&gt;\tau, x&gt;\ensuremath{x^{\prime}}\}} d[\delta_{\left\{T_{i}, X_i\right\}}-Q] (t,x) d Q (t^{\prime}, \ensuremath{x^{\prime}}) \\
                                                      &amp;\quad + \int \int 1_{\{t \leq \tau, t^{\prime}&gt;\tau, x&gt;\ensuremath{x^{\prime}}\}} d Q(t, x) d [\delta_{\left\{T_{i}, X_i\right\}}-Q](t^{\prime}, \ensuremath{x^{\prime}}) \\
&amp;= \int_{-\infty}^\infty \int_{0}^{\tau} Q(T&gt;\tau, X&lt;x) d\left[\delta_{\left\{T_{i}, X_i\right\}}-Q\right](t,x)\\
                                                      &amp;\quad +\int_{-\infty}^\infty \int_{\tau}^{\infty}  Q\left(T \leqslant \tau, X&gt;\ensuremath{x^{\prime}}\right) d\left[\delta_{\left\{T_{i}, X_i\right\}}-Q\right](t',x')\\
&amp;=1_{\left\{T_{i} \leqslant \tau\right\}} Q\left(T&gt;\tau, X&lt;X_{i}\right) +1_{\left\{T_{i}&gt;\tau\right\}} Q\left(T \leqslant \tau, X&gt;X_{i}\right)-2\nu_{\tau}(Q).
\end{align*}\]</span></p>
<p>Now we consider the functional <span class="math inline">\(\mu_{\tau}:\mathcal{Q}\to [0,1]\)</span> corresponding to the denominator of the : <span class="math display">\[
\mu_{\tau}(Q)=\int \int 1_{\{t \leq \tau, t^{\prime}&gt;\tau\}} d Q(t, x) d Q (t^{\prime}, \ensuremath{x^{\prime}})=Q(T \leq \tau, T' &gt; \tau).
\]</span> An analogous calculation yields that <span class="math display">\[
\partial_{\varepsilon} \mu_{\tau}(Q_{\varepsilon}) = 1_{\left\{T_{i} \leqslant \tau\right\}} Q\left(T&gt;\tau\right)+1_{\left\{T_{i}&gt;\tau\right\}} Q\left(T \leqslant \tau\right)-2\mu_{\tau}(Q)
\]</span> The quotient rule now yields that the Gateaux derivative for the functional <span class="math inline">\(\ensuremath{\operatorname{AUC}}_{\tau}(Q)={\nu_{\tau}(Q)}/{\mu_{\tau}(Q)}\)</span> is given by <span class="math display">\[\begin{align*}
 &amp;IF_{\ensuremath{\operatorname{AUC}}}(T_i,X_i;\tau) =  (\mu_{\tau}(Q))^{-2}\\
                                             &amp;\quad \left[1_{\left\{T_{i} \leqslant \tau\right\}} (Q\left(T&gt;\tau, X&lt;X_{i}\right)\mu_{\tau}(Q)-Q(T &gt; \tau) \nu_{\tau}(Q))\right.\\
  &amp;\quad \left. +1_{\left\{T_{i}&gt;\tau\right\}} (Q\left(T \leqslant \tau, X&gt;X_{i}\right)\mu_{\tau}(Q) - \nu_{\tau}(Q)Q(T\leq \tau))\right].
\end{align*}\]</span></p>
</div>
<div class="section level2">
<h2 id="influence-function-with-censoring-and-multiple-events">Influence function with censoring and multiple events<a class="anchor" aria-label="anchor" href="#influence-function-with-censoring-and-multiple-events"></a>
</h2>
<p>In this section, we derive the Influence function for the AUC with more than event and censoring (where the censoring is allowed to depend on the covariates). We now suppose that the censoring distribution depends on the baseline covariates but continue to assume that the censoring time is conditionally independent of the event time and event type given the covariates. To describe the situation with competing risks we introduce a new random variable <span class="math inline">\(D\in\{1,2\}\)</span> which indicates the cause (i.e., type of the event) observed at time <span class="math inline">\(T\)</span> such that <span class="math inline">\(D=1\)</span> means that the event of interest occurred, and <span class="math inline">\(D=2\)</span> that a competing risk occurred. As in the survival setting we let <span class="math inline">\(Q\)</span> denote the joint probability measure of the uncensored data, <span class="math inline">\((T,D,X)\sim Q\)</span>, and <span class="math inline">\(P\)</span> the joint probability measure of the right censored data <span class="math inline">\(Z=(\tilde{T},\Delta,X) \sim P\)</span> now with <span class="math inline">\(\Delta=D 1_{\{T \leq C\}}\)</span> taking values in the set <span class="math inline">\(\{0,1,2\}\)</span>. We are interested in the following definition of the time-dependent discrimination measure for cause 1: <span class="math display">\[\begin{align*}
\ensuremath{\operatorname{AUC}}^1(\tau)&amp;=Q(X_i &gt; X_j \mid T_i\leq \tau, D_i = 1, (T_j &gt; \tau \cup D_j = 2 ))\\
&amp;=\frac{Q(X_i &gt; X_j, T_i\leq \tau, D_i = 1, (T_j &gt; \tau \cup D_j = 2 ))}{Q(T_i\leq \tau, D_i = 1, (T_j &gt; \tau \cup D_j = 2 ))}
\end{align*}\]</span> We define a functional <span class="math inline">\(\nu^{1}_{\tau}(Q)\)</span> to represent the numerator: <span class="math display">\[\begin{align*}
\nu^{1}_{\tau}(Q) &amp;= \iint 1_{\{x &gt; x', t \leqslant \tau, d = 1, ( t^{\prime}&gt;\tau \cup d' = 2)\}} d Q(t, d, x) d Q\left(t^{\prime}, d', \ensuremath{x^{\prime}}\right) \nonumber\\
&amp;= \iint 1_{\{x &gt; x', t \leqslant \tau, ( t^{\prime}&gt;\tau \cup d' = 2)\}} d Q(t, 1, x) d Q\left(t^{\prime}, d', \ensuremath{x^{\prime}}\right)
\psi^{1}_{\tau}(P)  \nonumber\\
&amp;= \iint 1_{\{x &gt; x', t \leqslant \tau,t^{\prime}&gt;\tau\}} + 1_{\{ x &gt; x', t \leqslant \tau, t' \leqslant \tau, d' = 2)\}} d Q(t, 1, x) d Q\left(t^{\prime}, d', \ensuremath{x^{\prime}}\right) \nonumber\\
  &amp;= \iint 1_{\{x &gt; x', t \leqslant \tau,t^{\prime}&gt;\tau\}} dQ(t, 1, x) d Q\left(t^{\prime}, d', \ensuremath{x^{\prime}}\right) \nonumber\\
  &amp;\quad +  \iint 1_{\{ x &gt; x', t \leqslant \tau, t' \leqslant \tau \}} d Q(t, 1, x) d Q\left(t^{\prime}, 2, \ensuremath{x^{\prime}}\right) \nonumber\\
  &amp;= \sum_{\delta^{\prime}=0,1,2} \iint 1_{\{x &gt; x', t \leqslant \tau,  t^{\prime}&gt;\tau\}} \frac{d P(t, 1, x)}{G(t- | x)} \frac{d P\left(t^{\prime}, \delta^{\prime}, \ensuremath{x^{\prime}}\right)}{G\left(\tau | x' \right)} \label{eq:cr-part1-numerator}\\
  &amp;\quad + \iint 1_{\{ x &gt; x', t \leqslant \tau, t' \leqslant \tau \}} \frac{d P(t, 1, x)}{G(t-|x)} \frac{d P(t', 2, x')}{G(t'- | x')}
\end{align*}\]</span> We also need the influence function for the censoring as part of our calculations: <span class="math display">\[\begin{align*}
\kappa_{t,z}(P_{\varepsilon}^i) &amp;= \exp(-\int_0^t \frac{dP_{\varepsilon}(s,0|z)}{P_\varepsilon(\tilde{T} &gt; s|Z=z)}) \\
\partial_{\varepsilon} P_{\varepsilon}(\tilde{T} &gt;s , Z=z) &amp;= \mathbbm{1}_{\{\tilde{T}_i &gt; s, Z_i = z\}}-P(\tilde{T} &gt; s, Z = z) \\
\partial_{\varepsilon} P_{\varepsilon}(\tilde{T} \leq s, \Delta=0, Z=z) &amp;= \mathbbm{1}_{\{\tilde{T}_i \leq s,\Delta_i=0, Z_i = z\}}-P(\tilde{T} \leq s, \Delta=0, Z = z)
\end{align*}\]</span> We have when <span class="math inline">\(Z\)</span> is discrete, <span class="math display">\[\begin{align*}
  &amp;\partial_{\varepsilon} \left[\int_0^t \frac{dP_{\varepsilon}(s,0|z)}{P_\varepsilon(\tilde{T} &gt; s|Z=z)}\right]\\
  &amp;=\int_0^t \frac{\partial_{\varepsilon} dP_{\varepsilon}(s,0,z)P(\tilde{T}_i &gt; s,Z_i=z)}{P(\tilde{T} &gt; s,Z_i=z)^2}
     -\frac{dP(s,0,z)\partial_{\varepsilon} P_\varepsilon(\tilde{T} &gt;s, Z_i=z)}{P(\tilde{T} &gt; s,Z_i=z)^2}\\
  &amp;= \int_0^t \frac{ (d\mathbbm{1}_{\{\tilde{T}_i \leq s,\Delta_i=0, Z_i = z\}}-dP(s,0,z)) P(\tilde{T} &gt; s,Z_i=z)}{P(\tilde{T} &gt; s,Z=z)^2}\\
  &amp;\quad -\frac{dP(s,0,z) (\mathbbm{1}_{\{\tilde{T}_i &gt; s, Z_i = z\}}-P(\tilde{T} &gt; s, Z = z))}{P(\tilde{T} &gt; s,Z=z)^2}\\
  &amp;= \int_0^t \frac{ d\mathbbm{1}_{\{\tilde{T}_i \leq s,\Delta_i=0, Z_i = z\}} P(\tilde{T} &gt; s,Z=z)-dP(s,0,z) \mathbbm{1}_{\{\tilde{T}_i &gt; s, Z_i = z\}}}{P(\tilde{T} &gt; s,Z=z)^2}\\
  &amp;= \frac{\mathbbm{1}_{\{\tilde{T_i} \leq t, \Delta_i = 0, Z_i = z\}}}{P(\tilde{T} &gt; \tilde{T}_i,Z=Z_i)} -\int_0^t \frac{\mathbbm{1}_{\{\tilde{T}_i &gt; s, Z_i = z\}} dP(s,0,z) }{P(\tilde{T} &gt; s,Z=z)^2}\\
  &amp;= \frac{\mathbbm{1}_{\{\tilde{T_i} \leq t, \Delta_i = 0, Z_i = z\}}}{G(\tilde{T_i}|Z_i)S(\tilde{T_i}|Z_i)P(Z=Z_i)} -\int_0^{\tilde{T}_i \wedge t} \frac{ \mathbbm{1}_{\{ Z_i = z\} }dP(s,0,z)}{G(s|Z_i)^2S(s|Z_i)^2 P(Z=Z_i)^2}\\
  &amp;:= f_i(t,z)
\end{align*}\]</span> When <span class="math inline">\(Z\)</span> is continuous or mixed, the above has to be modified. Luckily, if we use the trick from before, we can do the calculation again which will mostly be the same, i.e. <span class="math display">\[
 f_i(t,z) = \frac{\mathbbm{1}_{\{\tilde{T_i} \leq t, \Delta_i = 0\}} \delta_{Z_i}(z)}{G(\tilde{T_i}|Z_i)S(\tilde{T_i}|Z_i)} -\int_0^{\tilde{T}_i \wedge t} \frac{ \delta_{Z_i}(z)dP(s,0 | z)}{G(s|Z_i)^2S(s|Z_i)^2}
\]</span> This just corresponds to setting <span class="math inline">\(\delta_{Z_i}(z) = \frac{{1}_{\{ Z_i = z\}} }{P(Z=Z_i)}\)</span> in the previous calculation.</p>
<p>We have <span class="math display">\[\begin{align*}
    \partial_{\varepsilon} \left[ \frac{d P_{\varepsilon}\left(t, \delta, x\right)}{\kappa(P_{\varepsilon})\left( s\right)}  \right] &amp;=\frac{d(\delta_{\left\{\tilde{T}_{i}, \Delta_i,X_i\right\}})(t, \delta, x)+dP(t,\delta,x)\left[f_i(s,x)-1\right]}{G(s|x)} 
\end{align*}\]</span> So calculations for <span class="math inline">\(\nu_\tau^1 (Q)\)</span> can now be done using the above. This yields that the influence function for the numerator can be written as: <span class="math display">\[\begin{align}
    \ensuremath{\mathrm{IF}_{\nu}}(\ensuremath{Z_i};\tau) &amp;= \frac{1_{\{\tilde{T}_i \leqslant \tau, \Delta_i = 1\}}}{G(\tilde{T_i}- | X_i)}\int  1_{\{X_i &gt; x', t^{\prime}&gt;\tau\}} \frac{dP(t' , x')}{G(\tau | x')} \\
    &amp;+\int 1_{\{t \leqslant \tau\}} \int  1_{\{x &gt; x', t^{\prime}&gt;\tau\}} \frac{dP(t', x')}{G(\tau | x')} \frac{\left[f_i(t-,x)-1\right]dP(t,1,x)}{G(t- | x)}  \\
    &amp;+ \iint 1_{\{x' &lt; x, t \leqslant \tau\}}  \frac{ d P (t, 1, x)}{G(t- | x)} \frac{1_{\{t^{\prime}&gt;\tau\}}\left[f_i(\tau,x')-1\right]dP(t',x')}{G(\tau | x')}  \\
    &amp;+ \left(\frac{1_{ \{ \tilde{T_i} \leq \tau, \Delta_i = 2\}} }{G(\tilde{T_i} - | X_i)} +  \frac{1_{ \{ \tilde{T_i} &gt; \tau \}} }{G(\tau | X_i )}\right) \int 1_{\{X_i&lt;x, t \leqslant \tau\}}  \frac{ d P (t, 1, x)}{G(t- | x)}\\
    &amp;+ \iint 1_{\{x' &lt; x, t \leqslant \tau\}} \frac{ d P (t, 1, x)}{G(t- | x)} 1_{\{t^{\prime} \leqslant \tau\}}(f_i(t'-,x')-1) \frac{dP(t',2,x') }{G(t'- | x')} \\
    &amp;+ \frac{1_{\{\tilde{T}_{i} \leqslant \tau, \Delta_i = 1\}}}{G(\tilde{T}_{i}- | X_i)}\int 1_{\{X_i &gt; x', t^{\prime} \leqslant \tau\}}  \frac{d P\left(t^{\prime},2, \ensuremath{x^{\prime}}\right)}{G(t'- | x')} \\
    &amp;+ \iint 1_{\{x &gt; x', t^{\prime} \leqslant \tau\}}  \frac{d P(dx') \mathcal{I}_{\{\delta'=2\}}}{G(t'- |x')}  1_{\{t \leqslant \tau\}}\frac{\left[f_i(t-,x)-1\right]dP(t,1,x)}{G(t-| x)}
\end{align}\]</span> Next, the denominator is <span class="math display">\[\begin{align}
    \ensuremath{\mathrm{IF}_{\mu}}(\ensuremath{Z_i};\tau) &amp;= \frac{1_{\{\tilde{T}_i \leqslant \tau, \Delta_i = 1\}}}{G(\tilde{T_i}- | X_i)}\int  1_{\{t^{\prime}&gt;\tau\}} \frac{dP(t' , x')}{G(\tau | x')} \\
    &amp;+\int  1_{\{ t^{\prime}&gt;\tau\}} \frac{dP(t', x')}{G(\tau | x')} \int 1_{\{t \leqslant \tau\}}  \frac{\left[f_i(t-,x)-1\right]dP(t,1,x)}{G(t- | x)}  \\
    &amp;+\int 1_{\{t \leqslant \tau\}}  \frac{ d P (t, 1, x)}{G(t- | x)}  \int \frac{1_{\{t^{\prime}&gt;\tau\}}\left[f_i(\tau,x')-1\right]dP(t',x')}{G(\tau | x')} \\
    &amp;+ \left( \frac{1_{ \{ \tilde{T_i} \leq \tau, \Delta_i = 2\}} }{G(\tilde{T_i} - | X_i)}+\frac{1_{ \{ \tilde{T_i} &gt; \tau \}} }{G(\tau | X_i )}\right)\int 1_{\{t \leqslant \tau\}}  \frac{ d P (t, 1, x)}{G(t- | x)}\\
    &amp;+ \int 1_{\{t \leqslant \tau\}} \frac{ d P (t, 1, x)}{G(t- | x)} \int 1_{\{t^{\prime} \leqslant \tau\}} (f_i(t'-,x')-1) \frac{dP(t',2,x') }{G(t'- | x')} \\
    &amp;+ \frac{1_{\{\tilde{T}_{i} \leqslant \tau, \Delta_i = 1\}}}{G(\tilde{T}_{i}- | X_i)}\int 1_{\{t^{\prime} \leqslant \tau\}}  \frac{d P\left(t^{\prime},2, \ensuremath{x^{\prime}}\right)}{G(t'- | x')} \\
    &amp;+ \int 1_{\{t \leqslant \tau\}} (f_i(t-,x)-1) \frac{ d P (t, 1, x)}{G(t- | x)} \int 1_{\{t^{\prime} \leqslant \tau\}}  \frac{dP(t',2,x') }{G(t'- | x')}
\end{align}\]</span> The quotient rule now yields that the Gateaux derivative for the functional <span class="math inline">\(\ensuremath{\operatorname{AUC}}_{\tau}(P)={\nu_{\tau}(Q)}/{\mu_{\tau}(Q)}\)</span> is given by <span class="math display">\[\begin{equation*}
    \ensuremath{\mathrm{IF}_{\mathrm{AUC}}}(Z_i,\tau)=\frac{\ensuremath{\mathrm{IF}_{\nu}}(\ensuremath{Z_i};\tau)  \mu_{\tau}(Q) - \nu_{\tau}(Q)  \ensuremath{\mathrm{IF}_{\mu}}(\ensuremath{Z_i};\tau)} {\mu_{\tau}(Q)^2}
\end{equation*}\]</span> Note that the terms involving 1 actually cancel each other out in the final calculation, so we can also write that <span class="math display">\[\begin{align*}
    \ensuremath{\mathrm{IF}_{\nu}}(\ensuremath{Z_i};\tau) &amp;= \frac{1_{\{\tilde{T}_i \leqslant \tau, \Delta_i = 1\}}}{G(\tilde{T_i}- | Z_i)}\int 1_{\{X_i &gt; x'\}}  \left(1_{\{t^{\prime}&gt;\tau\}} \frac{1}{G(\tau | z')}+  1_{\{t^{\prime} \leqslant \tau\}}  \frac{\mathcal{I}_{\{\delta'=2\}}}{G(t'- | z')}\right) P(dx') \\
    &amp;+\iint  1_{\{x &gt; x'\}}\left(1_{\{t^{\prime}&gt;\tau\}} \frac{1}{G(\tau | z')}+  1_{\{t^{\prime} \leqslant \tau\}}  \frac{\mathcal{I}_{\{\delta'=2\}}}{G(t'- | z')}\right) P(dx')  1_{\{t \leqslant \tau\}} \frac{f_i(t-,z   )P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | z)}  \\
    &amp;+ \iint   1_{\{x &gt; x'\}}  1_{\{t \leqslant \tau\}}  \frac{P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | z)} \left( \frac{1_{\{t^{\prime}&gt;\tau\}} f_i(\tau,z')}{G(\tau | z')} + 1_{\{t^{\prime} \leqslant \tau\}}f_i(t'-,z') \frac{\mathcal{I}_{\{\delta'=2\}}}{G(t'- | z')} \right)P(dx')\\
    &amp;+ \left(\frac{1_{ \{ \tilde{T_i} \leq \tau, \Delta_i = 2\}} }{G(\tilde{T_i} - | Z_i)} +  \frac{1_{ \{ \tilde{T_i} &gt; \tau \}} }{G(\tau | Z_i )}\right) \int  1_{\{x &gt; X_i\}}1_{\{t \leqslant \tau\}}  \frac{P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | x)}
\end{align*}\]</span> Similarly for the denominator, we need to do this, so <span class="math display">\[\begin{align*}
    \ensuremath{\mathrm{IF}_{\mu}}(\ensuremath{Z_i};\tau) &amp;= \frac{1_{\{\tilde{T}_i \leqslant \tau, \Delta_i = 1\}}}{G(\tilde{T_i}- | Z_i)}\int   \left(1_{\{t^{\prime}&gt;\tau\}} \frac{1}{G(\tau | z')}+  1_{\{t^{\prime} \leqslant \tau\}}  \frac{\mathcal{I}_{\{\delta'=2\}}}{G(t'- | z')}\right) P(dx') \\
    &amp;+\int \left(1_{\{t^{\prime}&gt;\tau\}} \frac{1}{G(\tau | z')}+  1_{\{t^{\prime} \leqslant \tau\}}  \frac{\mathcal{I}_{\{\delta'=2\}}}{G(t'- | z')}\right) P(dx') \int 1_{\{t \leqslant \tau\}} \frac{f_i(t-,z   )P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | z)}  \\
    &amp;+ \int  1_{\{t \leqslant \tau\}}  \frac{P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | z)} \int \left( \frac{1_{\{t^{\prime}&gt;\tau\}} f_i(\tau,z')}{G(\tau | z')} + 1_{\{t^{\prime} \leqslant \tau\}}f_i(t'-,z') \frac{\mathcal{I}_{\{\delta'=2\}}}{G(t'- | z')} \right)P(dx')\\
    &amp;+ \left(\frac{1_{ \{ \tilde{T_i} \leq \tau, \Delta_i = 2\}} }{G(\tilde{T_i} - | Z_i)} +  \frac{1_{ \{ \tilde{T_i} &gt; \tau \}} }{G(\tau | Z_i )}\right) \int 1_{\{t \leqslant \tau\}}  \frac{P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | x)}
\end{align*}\]</span></p>
<div class="section level3">
<h3 id="some-simpler-cases">Some simpler cases<a class="anchor" aria-label="anchor" href="#some-simpler-cases"></a>
</h3>
<ul>
<li>Whenever we have survival data instead of competing risk data, the terms corresponding to <span class="math inline">\(\Delta=2\)</span> can be set to zero, i.e.Â term 5-7 and 12-14. Also, the first part of 4 and 11 is set to zero.</li>
<li>Whenever we have censoring that does not depend on the covariates, terns 2-3 simplify a bit and are instead written as:</li>
</ul>
<p><span class="math display">\[\begin{gather*}
\frac{f_i(\tau)-2}{G(\tau)}\int 1_{\{t \leqslant \tau\}} P(X&lt;x, \tilde{T}&gt;\tau) \frac{1}{G(t-)}dP(t,1,x) \\
+ \frac{1}{G(\tau)} \int 1_{\{t \leqslant \tau\}} P(X&lt;x, \tilde{T}&gt;\tau) \frac{f_i(t-)}{G(t-)}dP(t,1,x) 
\end{gather*}\]</span></p>
<p>Similar corrections hold for the denominator. In the code, terms (1-7) are now termed (8-14) and (8-14) are now termed (15-21). Note that <span class="math inline">\(P(X &lt; X_i, \tilde{T} &gt; \tau) = \int 1_{\{t &gt; \tau, x &lt; X_i\}} dP(t,x)\)</span>.</p>
</div>
<div class="section level3">
<h3 id="notes-on-the-case-with-covariates">Notes on the case with covariates<a class="anchor" aria-label="anchor" href="#notes-on-the-case-with-covariates"></a>
</h3>
<ul>
<li>Term (2), (5) and (7) (and also (9), (12), and (14)) may be evaluated by noting the following <span class="math display">\[
\scriptstyle
\int_X \int_0^\tau H(x)f_i(t-,x) \frac{P(dt,k,x)}{G(t-|x)} = H(X_i)\left(\frac{I(\tilde{T}_i \leq \tau, \Delta_i = 0)}{G(\tilde{T}_i|X_i)S(\tilde{T}_i|X_i)}(F_k(\tau|X_i)-F_k(\tilde{T}_i|X_i))-\int_0^{\tilde{T}_i \wedge \tau} \frac{(F_k(\tau|X_i)-F_k(s|X_i))}{G(s|X_i)^2S(s|X_i)^2}P(ds,0|X_i)\right)
\]</span> where <span class="math inline">\(H\)</span> is an arbitrary function of <span class="math inline">\(x\)</span> (but not <span class="math inline">\(t\)</span>!), <span class="math inline">\(k \in \{1,2\}\)</span> and <span class="math inline">\(F_k\)</span> is the subdistribution function for cause <span class="math inline">\(k\)</span>.</li>
<li>For Term (3) (and similarly (10)), we can use that<br><span class="math display">\[
\begin{aligned}
\scriptstyle
\int_ X\int H(x')  1_{\{t' &gt; \tau\}} f_i(\tau, x')\frac{P(dt',dx')}{G(\tau | x')}&amp;=\frac{H(X_i)}{G(\tau | X_i)} P(\tilde{T} &gt; \tau | X_i)\left(\frac{I(\tilde{T}_i \leq \tau, \Delta_i = 0)}{G(\tilde{T}_i|X_i)S(\tilde{T}_i|X_i)}-\int_0^{\tilde{T}_i \wedge \tau} \frac{1}{G(s|X_i)^2S(s|X_i)^2}P(ds,0|X_i)\right) \\
&amp;=H(X_i) S(\tau | X_i)\left(\frac{I(\tilde{T}_i \leq \tau, \Delta_i = 0)}{G(\tilde{T}_i|X_i)S(\tilde{T}_i|X_i)}-\int_0^{\tilde{T}_i \wedge \tau} \frac{1}{G(s|X_i)^2S(s|X_i)^2}P(ds,0|X_i)\right) \\
\end{aligned}
\]</span> where <span class="math inline">\(H\)</span> is again an arbitrary function.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="estimation">Estimation<a class="anchor" aria-label="anchor" href="#estimation"></a>
</h2>
<p>We estimate as follows: <span class="math display">\[\begin{align}
    \ensuremath{\mathrm{IF}_{\nu}}(\ensuremath{Z_i};\tau) &amp;= \frac{1_{\{\tilde{T}_i \leqslant \tau, \Delta_i = 1\}}}{\hat{G}(\tilde{T_i}- | X_i)}\int  1_{\{X_i &gt; x', t^{\prime}&gt;\tau\}} \frac{d\ensuremath{I\negthickspace P_n}(t' , x')}{\hat{G}(\tau | x')} \\
    &amp;+\int 1_{\{t \leqslant \tau\}} \int  1_{\{x &gt; x', t^{\prime}&gt;\tau\}} \frac{d\ensuremath{I\negthickspace P_n}(t', x')}{\hat{G}(\tau | x')} \frac{\left[\hat{f}_i(t-,x)-1\right]d\ensuremath{I\negthickspace P_n}(t,1,x)}{\hat{G}(t- | x)}  \\
    &amp;+ \iint 1_{\{x' &lt; x, t \leqslant \tau\}}  \frac{ d \ensuremath{I\negthickspace P_n}(t, 1, x)}{\hat{G}(t- | x)} \frac{1_{\{t^{\prime}&gt;\tau\}}\left[\hat{f}_i(\tau,x')-1\right]d\ensuremath{I\negthickspace P_n}(t',x')}{\hat{G}(\tau | x')}  \\
    &amp;+ \left(\frac{1_{ \{ \tilde{T_i} \leq \tau, \Delta_i = 2\}} }{\hat{G}(\tilde{T_i} - | X_i)} +  \frac{1_{ \{ \tilde{T_i} &gt; \tau \}} }{\hat{G}(\tau | X_i )}\right) \int 1_{\{X_i&lt;x, t \leqslant \tau\}}  \frac{ d \ensuremath{I\negthickspace P_n}(t, 1, x)}{\hat{G}(t- | x)}\\
    &amp;+ \iint 1_{\{x' &lt; x, t \leqslant \tau\}} \frac{ d \ensuremath{I\negthickspace P_n}(t, 1, x)}{\hat{G}(t- | x)} 1_{\{t^{\prime} \leqslant \tau\}}(f_i(t'-,x')-1) \frac{d\ensuremath{I\negthickspace P_n}(t',2,x') }{\hat{G}(t'- | x')} \\
    &amp;+ \frac{1_{\{\tilde{T}_{i} \leqslant \tau, \Delta_i = 1\}}}{\hat{G}(\tilde{T}_{i}- | X_i)}\int 1_{\{X_i &gt; x', t^{\prime} \leqslant \tau\}}  \frac{d \ensuremath{I\negthickspace P_n}\left(t^{\prime},2, \ensuremath{x^{\prime}}\right)}{\hat{G}(t'- | x')} \\
    &amp;+ \iint 1_{\{x &gt; x', t^{\prime} \leqslant \tau\}}  \frac{d \ensuremath{I\negthickspace P_n}\left(t^{\prime},2, \ensuremath{x^{\prime}}\right)}{\hat{G}(t'- |x')}  1_{\{t \leqslant \tau\}}\frac{\left[\hat{f}_i(t-,x)-1\right]d\ensuremath{I\negthickspace P_n}(t,1,x)}{\hat{G}(t-| x)}
\end{align}\]</span> Next, the denominator is <span class="math display">\[\begin{align}
    \ensuremath{\mathrm{IF}_{\mu}}(\ensuremath{Z_i};\tau) &amp;= \frac{1_{\{\tilde{T}_i \leqslant \tau, \Delta_i = 1\}}}{\hat{G}(\tilde{T_i}- | X_i)}\int  1_{\{t^{\prime}&gt;\tau\}} \frac{d\ensuremath{I\negthickspace P_n}(t' , x')}{\hat{G}(\tau | x')} \\
    &amp;+\int  1_{\{ t^{\prime}&gt;\tau\}} \frac{d\ensuremath{I\negthickspace P_n}(t', x')}{\hat{G}(\tau | x')} \int 1_{\{t \leqslant \tau\}}  \frac{\left[\hat{f}_i(t-,x)-1\right]d\ensuremath{I\negthickspace P_n}(t,1,x)}{\hat{G}(t- | x)}  \\
    &amp;+\int 1_{\{t \leqslant \tau\}}  \frac{ d \ensuremath{I\negthickspace P_n}(t, 1, x)}{\hat{G}(t- | x)}  \int \frac{1_{\{t^{\prime}&gt;\tau\}}\left[\hat{f}_i(\tau,x')-1\right]d\ensuremath{I\negthickspace P_n}(t',x')}{\hat{G}(\tau | x')} \\
    &amp;+ \left( \frac{1_{ \{ \tilde{T_i} \leq \tau, \Delta_i = 2\}} }{\hat{G}(\tilde{T_i} - | X_i)}+\frac{1_{ \{ \tilde{T_i} &gt; \tau \}} }{\hat{G}(\tau | X_i )}\right)\int 1_{\{t \leqslant \tau\}}  \frac{ d \ensuremath{I\negthickspace P_n}(t, 1, x)}{\hat{G}(t- | x)}\\
    &amp;+ \int 1_{\{t \leqslant \tau\}} \frac{ d \ensuremath{I\negthickspace P_n}(t, 1, x)}{\hat{G}(t- | x)} \int 1_{\{t^{\prime} \leqslant \tau\}} (\hat{f}_i(t'-,x')-1) \frac{d\ensuremath{I\negthickspace P_n}(t',2,x') }{\hat{G}(t'- | x')} \\
    &amp;+ \frac{1_{\{\tilde{T}_{i} \leqslant \tau, \Delta_i = 1\}}}{\hat{G}(\tilde{T}_{i}- | X_i)}\int 1_{\{t^{\prime} \leqslant \tau\}}  \frac{d \ensuremath{I\negthickspace P_n}\left(t^{\prime},2, \ensuremath{x^{\prime}}\right)}{\hat{G}(t'- | x')} \\
    &amp;+ \int 1_{\{t \leqslant \tau\}} (\hat{f}_i(t-,x)-1) \frac{ d \ensuremath{I\negthickspace P_n}(t, 1, x)}{\hat{G}(t- | x)} \int 1_{\{t^{\prime} \leqslant \tau\}}  \frac{d\ensuremath{I\negthickspace P_n}(t',2,x') }{\hat{G}(t'- | x')}
\end{align}\]</span></p>
<p>We suggest for estimating this, that the inner part of the integrals are estimated first, because (1) some of the inner integrals appear more than once and (2) for efficiency reasons. Note that, when we have that the censoring is independent of the covariates, we might do some other optimizations as well: We assume that the survival times are sorted and possibly with ties such that <span class="math inline">\(\tilde{T}_{1} &lt; \ldots &lt; \tilde{T}_{i} = \ldots = \tilde{T}_{i+k} &lt; \tilde{T}_{i+k+1} &lt; \ldots &lt; \tilde{T}_n\)</span>. We use the following algorithm to preserve memory and the number of iterations for say <span class="math inline">\(\mu^{(i)} = \int 1_{\{t \leqslant \tau\}} \frac{f_i(t-)}{G(t-)}dP(t,1,x)\)</span>. The idea is to split the sum into two terms: <span class="math display">\[\begin{gather*}
\frac{1}{n} \sum_{j=1}^n \frac{\hat{f_i}(\tilde{T}_j - )1_{ \{
    \tilde{T}_j \leq \tau, \Delta_j =1 \}}}{\hat{G}(\tilde{T_j}-)} =\\
\frac{1}{n} \left(\sum_{j=2}^{i+k} \frac{g(j) 1_{ \{ \tilde{T}_j \leq
      \tau, \Delta_j =1 \}}}{\hat{G}(\tilde{T_j}-)} +
  h(i)
  \sum_{j=i+k+1}^n \frac{1_{ \{ \tilde{T}_j \leq \tau, \Delta_j =1
      \}}}{\hat{G}(\tilde{T_j}-)} \right)
\end{gather*}\]</span></p>
since <span class="math inline">\(\hat{f_i}(\tilde{T}_j - )\)</span> only depends on <span class="math inline">\(i\)</span> for <span class="math inline">\(i+k &gt; j\)</span> and only depends on <span class="math inline">\(j\)</span> for <span class="math inline">\(i+k\leq j\)</span>, so these values are calculated a priori. Also the first term will always be zero, since we are looking at the value of the integral before any observed event (hence the sum starts at <span class="math inline">\(j=2\)</span>). One can check in the estimation of the Influence Curve for the censoring, which does not depend on the covariates that we need to calculate <span class="math inline">\(2n\)</span> values (i.e.Â <span class="math inline">\(n\)</span> values for <span class="math inline">\(g(i)\)</span> and <span class="math inline">\(n\)</span> for <span class="math inline">\(h(j)\)</span>). This is how we can avoid memory issues. The algorithm is:

<p>The idea is that but we keep on adding and subtracting the terms with tied values in the event times. Then we do not need to calculate a sum for each <span class="math inline">\(i\)</span>.</p>
<p>On the other hand, efficient calculation of some of the estimates can be done for example by sorting the risks <span class="math inline">\(X\)</span> in (1) for the integral there.</p>
</div>
<div class="section level2">
<h2 id="cross-validation">Cross-validation<a class="anchor" aria-label="anchor" href="#cross-validation"></a>
</h2>
<div class="section level3">
<h3 id="binary-case">Binary case<a class="anchor" aria-label="anchor" href="#binary-case"></a>
</h3>
<p>Our cross-validation algorithm repeatedly splits the dataset <span class="math inline">\(D_n\)</span> of size <span class="math inline">\(n\)</span> into training and validation datasets as follows. Let <span class="math inline">\(B\)</span> be a large integer. For each <span class="math inline">\(b=1,\ldots,B\)</span> we draw a bootstrap dataset <span class="math inline">\(D^*_{m,b}=\{X_{b,1}^*,\ldots,X_{b,m}^*\}\)</span> of size <span class="math inline">\(m\)</span> with replacement from the data <span class="math inline">\(D_n\)</span>. For <span class="math inline">\(i=1,\ldots,n\)</span> let <span class="math inline">\(N_i^b\)</span> be the number of times subject <span class="math inline">\(i\)</span> is included in <span class="math inline">\(D^*_{m,b}\)</span>. In step <span class="math inline">\(b\)</span> of the cross-validation algorithm the bootstrap dataset <span class="math inline">\(D^*_{m,b}\)</span> is used for training. We apply <span class="math inline">\(R\)</span> to <span class="math inline">\(D^*_{m,b}\)</span> to obtain the prediction model <span class="math inline">\(\ensuremath{R(D_{m,b}^*)}\)</span>. All subjects <span class="math inline">\(i\)</span> for which <span class="math inline">\(N_i^b=0\)</span> are out-of-bag and we let these subjects form the validation dataset of step <span class="math inline">\(b\)</span>. First let us construct the influence function in this case with binary data, <span class="math inline">\(X=(Y,Z)\)</span>. In this case, we consider estimation of the functional (i.e.Â the definition of the AUC in cross-validation)</p>
<p>In this section we extend the ideas from the previous section and define a IPCW estimator of AUC. The AUC can be written as <span class="math display">\[\begin{align*}
  \text{AUC}(D_m)&amp;=\mathbb{E}_{X_{m+1},X_{m+2}}\Big[\mathcal{I}_{\{\ensuremath{R_{\tau}}(D_m)(Z_{m+1})&gt;\ensuremath{R_{\tau}}(D_m)(Z_{m+2})\}}\big\vert Y_{m+1} = 1, Y_{m+2} = 0, D_m\Big] \\
  &amp;=\frac{\mathbb{E}_{X_{m+1},X_{m+2}}\Big[\mathcal{I}_{\{\ensuremath{\ensuremath{R_{\tau}}(D_m)}(Z_{m+1})&gt;\ensuremath{\ensuremath{R_{\tau}}(D_m)}(Z_{m+2})\}} \mathcal{I}_{\{Y_{m+1} = 1\}}\mathcal{I}_{\{Y_{m+2} = 0\}}\big\vert D_m\Big]}
  {\mathbb{E}_{X_{m+1}}\Big[\mathcal{I}_{\{Y_{m+1} = 1\}}\Big]\mathbb{E}_{X_{m+2}}\Big[\mathcal{I}_{\{Y_{m+2} = 0\}}\Big]} 
\end{align*}\]</span> With the notation <span class="math display">\[\begin{equation*}
  \Theta_{m}(Z_{m+1},Z_{m+2})=\mathbb{E}_{D_m}\big[\mathcal{I}_{\{\ensuremath{\ensuremath{R_{\tau}}(D_m)}(Z_{m+1})&gt;\ensuremath{\ensuremath{R_{\tau}}(D_m)}(Z_{m+2})\}}\big\vert Z_{m+1},Z_{m+2}\big],
\end{equation*}\]</span> the expected parameter <span class="math inline">\(\theta_{m} =\mathbb{E}_{D_n}\big[\text{AUC}(D_n)\big]\)</span> can then be written as <span class="math display">\[\begin{align}
  \theta_{m} &amp;=\mathbb{E}_{D_m}\left[\frac{\mathbb{E}_{X_{m+1},X_{m+2}}\Big[\mathcal{I}_{\{\ensuremath{\ensuremath{R_{\tau}}(D_m)}(Z_{m+1})&gt;\ensuremath{\ensuremath{R_{\tau}}(D_m)}(Z_{m+2})\}} \mathcal{I}_{\{Y_{m+1} = 1\}}\mathcal{I}_{\{Y_{m+2} = 0\}}\big\vert D_m\Big]}
  {\mathbb{E}_{X_{m+1}}\Big[\mathcal{I}_{\{Y_{m+1} = 1\}}\Big]\mathbb{E}_{X_{m+2}}\Big[\mathcal{I}_{\{Y_{m+2} = 0\}}\Big]}\right]\nonumber\\
  &amp;=\frac{\mathbb{E}_{X_{m+1},X_{m+2}}\left[\Theta_{m}(Z_{m+1},Z_{m+2})\mathcal{I}_{\{Y_{m+1} = 1\}}\mathcal{I}_{\{Y_{m+2} = 0\}}\right]}
  {\mathbb{E}_{X_{m+1}}\Big[\mathcal{I}_{\{Y_{m+1} = 1\}}\Big]\mathbb{E}_{X_{m+2}}\Big[\mathcal{I}_{\{Y_{m+2} = 0\}}\Big]}=\frac{\mathcal{A}_{\tau,m}}{\mathcal{B}_{\tau}}
\end{align}\]</span></p>
<p>As before, let <span class="math inline">\(D^*_{m,b}\)</span> be a bootstrap sample drawn with replacement from <span class="math inline">\(D_m\)</span>, and let <span class="math inline">\(\ensuremath{R(D_{m,b}^*)}\)</span> be a prediction modeling algorithm trained in <span class="math inline">\(D^*_{m,b}\)</span>. The idea of the estimator is to evaluate the concordance of predicted risks obtained from <span class="math inline">\(\ensuremath{R(D_{m,b}^*)}\)</span> for all pairs of subjects <span class="math inline">\((i,j)\)</span> for which both subject <span class="math inline">\(i\)</span> and subject <span class="math inline">\(j\)</span> is out-of-bag<br><span class="math display">\[\begin{equation*}
  \mathcal{I}_{\{\ensuremath{R(D_{m,b}^*)}(Z_i)&gt;\ensuremath{R(D_{m,b}^*)}(Z_j)\}}\mathcal{I}_{\{N_i^b=0\}}\mathcal{I}_{\{N_j^b=0\}}
\end{equation*}\]</span><br>
The contribution of pair <span class="math inline">\((i,j)\)</span> to the estimator is the average concordance over all bootstrap samples for which both <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> are out-of-bag <span class="math display">\[\begin{equation}
\label{eq:lpo}
  \hat{\Theta}^{(1,1)}_{m}(Z_{i},Z_{j})=\frac{\sum_{b=1}^{B}\mathcal{I}_{\{\ensuremath{R(D_{m,b}^*)}(Z_{i})&gt;\ensuremath{R(D_{m,b}^*)}(Z_{j})\}}\mathcal{I}_{\{N_i^b=0\}}\mathcal{I}_{\{N_j^b=0\}}}{\sum_{b=1}^{B}\mathcal{I}_{\{N_i^b=0\}}\mathcal{I}_{\{N_j^b=0\}}}
\end{equation}\]</span> In the case of no censoring, the estimate of <span class="math inline">\(\theta_{\tau,m}\)</span> is obtained by inserting <span class="math inline">\(\hat{\Theta}^{(1,1)}_{m}\)</span> in <span class="math inline">\(\theta_m\)</span> and replacing the expectations by empirical means <span class="math display">\[\begin{equation*}
  \frac{1}{n^2}\frac{1}{\hat{\mathcal{B}}}\sum_{i=1}^n\sum_{j=1}^n\hat{\Theta}^{(1,1)}_{m}(Z_{i},Z_{j})\mathcal{I}_{\{Y_i=1\}}\mathcal{I}_{\{Y_j=0\}},
\end{equation*}\]</span> with <span class="math inline">\(\hat{\mathcal{B}}=n^{-2}\big[\sum_{i=1}^n\mathcal{I}_{\{Y_i=1\}}\big]\big[\sum_{j=1}^n\mathcal{I}_{\{Y_j=0\}}\big]\)</span>.</p>
</div>
<div class="section level3">
<h3 id="influence-function-generally">Influence function (generally)<a class="anchor" aria-label="anchor" href="#influence-function-generally"></a>
</h3>
<p>We note that we may actually use our results from the test-train section on any functional, <span class="math inline">\(\phi(D_m)_\tau\)</span> defined in the test-train situation. Then the influence function of the function <span class="math inline">\(\Phi_\tau := \mathbb{E}_{D_m} [\phi(D_m)_\tau]\)</span> (with <span class="math inline">\(\tau\)</span> removed from the notation if we are in the binary sitaution) from the test-train situation as follows by finding the Gateaux derivative for observation <span class="math inline">\(i\)</span></p>
<p><span class="math display">\[
\int \cdots \int \text{IC}_{\phi(D_m)_\tau}^i P(dx_1) \cdots P(dx_m) + \sum_{j=1}^m  \int \cdots \int \phi(D_m)_\tau \delta_{x_j}(x_k) \prod_{i \neq j} P(dx_i) - m \Phi_\tau 
\]</span></p>
<p>Then using that approximately, we have that <span class="math display">\[
\int \cdots \int \phi(D_m)_\tau \delta_{x_j}(x_k) \prod_{i \neq j} P(dx_i) \approx  \int \cdots \int \phi(D_m)_\tau P(dx_j)\prod_{i \neq j} P(dx_i) := \Phi_\tau 
\]</span> i.e.Â we use the expected value as an approximation of the actual value (this is ok assuming that the variance of the LHS is not too large, i.e.Â the error from assuming this may be determined by using Chebyshevs inequality (and other concentration inequalities), so that the variance of the LHS goes to zero, when <span class="math inline">\(m, n \rightarrow \infty\)</span> (in the appropriate manner)!, i.e.Â the difference is <span class="math inline">\(o_p(1)\)</span>; otherwise we may try to show that <span class="math inline">\(\frac{1}{\sqrt{n}}\sum_k [\int \cdots \int \phi(D_m)_\tau \delta_{x_j}(x_k) \prod_{i \neq j} P(dx_i) - \int \cdots \int \phi(D_m)_\tau P(dx_j)\prod_{i \neq j} P(dx_i))] = o_p(1)\)</span>, so that the influence function with these terms removed is actually the influence function and not an approximation), so we have the Gateux derivative</p>
<p><span class="math display">\[
\int \cdots \int \text{IC}_{\phi(D_m)_\tau}^i P(dx_1) \cdots P(dx_m)
\]</span></p>
<p>and we know <span class="math display">\[\text{IC}_{\phi(D_m)_\tau}^i\]</span> from the train-test situation. Thus, by interchanging the integrals, we get after some calculations, <span class="math display">\[\begin{align*}
  &amp;\text{IF}_{\nu}(m;x_k)=\frac{1}{\eta(\ensuremath{\mathrm{P}})}\Big[\int\Theta_{m}(z_{m+1},z_k)\mathcal{I}_{\{y_{k}=1,y_{m+2}=0\}}\ensuremath{\mathrm{P}}(\mathrm{d}x_{m+1})\\
  &amp;\hspace{3cm}+\int\Theta_{m}(z_k,z_{m+2})\mathcal{I}_{\{y_{m+1}=1,y_{k}=0\}}\ensuremath{\mathrm{P}}(\mathrm{d}x_{m+2})\Big]\\
  &amp;-\frac{\nu_{m}(\ensuremath{\mathrm{P}})}{\eta(\ensuremath{\mathrm{P}})}\Big[\mathcal{I}_{\{y_k=1\}}\Big]
  \Big[\int \mathcal{I}_{\{y_{m+2}=0\}}\ensuremath{\mathrm{P}}(\mathrm{d}x_{m+2})\Big]\\
  &amp;-\frac{\nu_{n}(\ensuremath{\mathrm{P}})}{\eta(\ensuremath{\mathrm{P}})}\Big[\int \mathcal{I}_{\{y_{m+1}=1\}}\ensuremath{\mathrm{P}}(\mathrm{d}x_{m+1})\Big]
  \Big[\mathcal{I}_{\{y_k=0\}}\Big]
\end{align*}\]</span></p>
</div>
<div class="section level3">
<h3 id="estimating-the-influence-function">Estimating the Influence function<a class="anchor" aria-label="anchor" href="#estimating-the-influence-function"></a>
</h3>
<p>We suggest to estimate the influence function by <span class="math display">\[\begin{align*}
  &amp;\hat{\text{IF}}_{\nu}(\tau,m;X_k)=\frac{1}{n}\frac{1}{\hat{\mathcal{B}}} \Bigg[\sum_{i=1}^n\hat{\Theta}^{(1,1)}_{m}(Z_i,Z_k)\mathcal{I}_{\{Y_i=1,Y_k= 0\}}
  +\sum_{j=1}^n\hat{\Theta}^{(1,1)}_{m}(Z_k,Z_j)\mathcal{I}_{\{Y_k=1,Y_j = 0\}} \Bigg]\\
      &amp;-\frac{\ensuremath{\hat{\theta}^{(1,1)}_{m}}}{\hat{\mathcal{B}}} \Bigg[\mathcal{I}_{\{Y_k = 1\}}\Bigg]
  \Bigg[\frac{1}{n}\sum_{j=1}^n \mathcal{I}_{\{Y_j = 0\}}\Bigg]\\
  &amp;-\frac{\ensuremath{\hat{\theta}^{(1,1)}_{m}}}{\hat{\mathcal{B}}_{\tau}}\Bigg[\frac{1}{n}\sum_{i=1}^n \mathcal{I}_{\{Y_i = 1\}} \Bigg]
  \Bigg[\mathcal{I}_{\{Y_k = 0\}}\Bigg]
\end{align*}\]</span></p>
</div>
</div>
<div class="section level2">
<h2 id="survival-and-competing-risk-cases">Survival and Competing risk cases<a class="anchor" aria-label="anchor" href="#survival-and-competing-risk-cases"></a>
</h2>
<p>The idea is the same as before. Let <span class="math inline">\(\nu^{1}_{\tau,m}(P)\)</span> be the numerator of the cross-validated AUC. Then, for the most general case (competing risk case), we get that <span class="math display">\[\begin{align*}
\frac{\ensuremath{\mathrm{IF}_{\nu}}(\ensuremath{Z_i};\tau,m)\mu_\tau(P) - \nu^{1}_{\tau,m}(P) \ensuremath{\mathrm{IF}_{\mu}}(\ensuremath{Z_i};\tau)}{\mu_\tau(P)^2 }
\end{align*}\]</span> Note that <span class="math inline">\(\mu_{\tau}(P)\)</span> is defined precisely as before (and also <span class="math inline">\(\ensuremath{\mathrm{IF}_{\mu}}\)</span> is the same, because they are constants in terms of <span class="math inline">\((x_1,...,x_m)\)</span>), but we must redefine, <span class="math inline">\(\ensuremath{\mathrm{IF}_{\nu}}\)</span> <span class="math display">\[\begin{align*}
    \ensuremath{\mathrm{IF}_{\nu}}(\ensuremath{Z_i};\tau,m) &amp;= \frac{1_{\{\tilde{T}_i \leqslant \tau, \Delta_i = 1\}}}{G(\tilde{T_i}- | Z_i)}\int  \Theta_m(X_i,x') 1_{\{t^{\prime}&gt;\tau\}} \frac{P(dx')}{G(\tau | z')} \\
    &amp;+\int 1_{\{t \leqslant \tau\}} \int  \Theta_m(x,x') 1_{\{t^{\prime}&gt;\tau\}} \frac{P(dx')}{G(\tau | z')} \frac{\left[f_i(t-,z   )-1\right] P(dx) \mathcal{I}_{\{\delta=1\}}} {G(t- | z)}  \\
    &amp;+ \iint  \Theta_m(x,x')  1_{\{t \leqslant \tau\}}  \frac{P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | z)} \frac{1_{\{t^{\prime}&gt;\tau\}}\left[f_i(\tau,z')-1\right]P(dx')}{G(\tau | z')}  \\
    &amp;+ \left(\frac{1_{ \{ \tilde{T_i} \leq \tau, \Delta_i = 2\}} }{G(\tilde{T_i} - | Z_i)} +  \frac{1_{ \{ \tilde{T_i} &gt; \tau \}} }{G(\tau | Z_i )}\right) \int \Theta_m(x,X_i )1_{\{t \leqslant \tau\}}  \frac{P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | x)}\\
    &amp;+ \iint \Theta_m(x,x') 1_{\{t \leqslant \tau\}} \frac{P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | z)} 1_{\{t^{\prime} \leqslant \tau\}}(f_i(t'-,z')-1) \frac{P(dx') \mathcal{I}_{\{\delta'=2\}}}{G(t'- | z')} \\
    &amp;+ \frac{1_{\{\tilde{T}_{i} \leqslant \tau, \Delta_i = 1\}}}{G(\tilde{T}_{i}- | Z_i)}\int \Theta_m(X_i,x') 1_{\{t^{\prime} \leqslant \tau\}}  \frac{P (dx') \mathcal{I}_{\{\delta'=2\}}}{G(t'- | z')} \\
    &amp;+ \iint \Theta_m(x,x') 1_{\{t^{\prime} \leqslant \tau\}}  \frac{P(dx')\mathcal{I}_{\{\delta=2\}}}{G(t'- |z')}  1_{\{t \leqslant \tau\}}\frac{\left[f_i(t-,z)-1\right]P(dx)\mathcal{I}_{\{\delta=1\}}}{G(t-| z)}
\end{align*}\]</span> We can remove the ones, and rewrite this to be <span class="math display">\[\begin{align}
    \ensuremath{\mathrm{IF}_{\nu}}(\ensuremath{Z_i};\tau,m) &amp;= \frac{1_{\{\tilde{T}_i \leqslant \tau, \Delta_i = 1\}}}{G(\tilde{T_i}- | Z_i)}\int  \Theta_m(X_i,x') \left(1_{\{t^{\prime}&gt;\tau\}} \frac{1}{G(\tau | z')}+  1_{\{t^{\prime} \leqslant \tau\}}  \frac{\mathcal{I}_{\{\delta'=2\}}}{G(t'- | z')}\right) P(dx') \\
    &amp;+\iint  \Theta_m(x,x') \left(1_{\{t^{\prime}&gt;\tau\}} \frac{1}{G(\tau | z')}+  1_{\{t^{\prime} \leqslant \tau\}}  \frac{\mathcal{I}_{\{\delta'=2\}}}{G(t'- | z')}\right) P(dx')  1_{\{t \leqslant \tau\}} \frac{f_i(t-,z   )P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | z)}  \\
    &amp;+ \iint  \Theta_m(x,x')  1_{\{t \leqslant \tau\}}  \frac{P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | z)} \left( \frac{1_{\{t^{\prime}&gt;\tau\}} f_i(\tau,z')}{G(\tau | z')} + 1_{\{t^{\prime} \leqslant \tau\}}f_i(t'-,z') \frac{\mathcal{I}_{\{\delta'=2\}}}{G(t'- | z')} \right)P(dx')\\
    &amp;+ \left(\frac{1_{ \{ \tilde{T_i} \leq \tau, \Delta_i = 2\}} }{G(\tilde{T_i} - | Z_i)} +  \frac{1_{ \{ \tilde{T_i} &gt; \tau \}} }{G(\tau | Z_i )}\right) \int \Theta_m(x,X_i )1_{\{t \leqslant \tau\}}  \frac{P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | x)}
\end{align}\]</span> Similarly for the denominator, we need to do this, so <span class="math display">\[\begin{align}
    \ensuremath{\mathrm{IF}_{\mu}}(\ensuremath{Z_i};\tau) &amp;= \frac{1_{\{\tilde{T}_i \leqslant \tau, \Delta_i = 1\}}}{G(\tilde{T_i}- | Z_i)}\int   \left(1_{\{t^{\prime}&gt;\tau\}} \frac{1}{G(\tau | z')}+  1_{\{t^{\prime} \leqslant \tau\}}  \frac{\mathcal{I}_{\{\delta'=2\}}}{G(t'- | z')}\right) P(dx') \\
    &amp;+\int \left(1_{\{t^{\prime}&gt;\tau\}} \frac{1}{G(\tau | z')}+  1_{\{t^{\prime} \leqslant \tau\}}  \frac{\mathcal{I}_{\{\delta'=2\}}}{G(t'- | z')}\right) P(dx') \int 1_{\{t \leqslant \tau\}} \frac{f_i(t-,z   )P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | z)}  \\
    &amp;+ \int  1_{\{t \leqslant \tau\}}  \frac{P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | z)} \int \left( \frac{1_{\{t^{\prime}&gt;\tau\}} f_i(\tau,z')}{G(\tau | z')} + 1_{\{t^{\prime} \leqslant \tau\}}f_i(t'-,z') \frac{\mathcal{I}_{\{\delta'=2\}}}{G(t'- | z')} \right)P(dx')\\
    &amp;+ \left(\frac{1_{ \{ \tilde{T_i} \leq \tau, \Delta_i = 2\}} }{G(\tilde{T_i} - | Z_i)} +  \frac{1_{ \{ \tilde{T_i} &gt; \tau \}} }{G(\tau | Z_i )}\right) \int 1_{\{t \leqslant \tau\}}  \frac{P(dx) \mathcal{I}_{\{\delta=1\}}}{G(t- | x)}
\end{align}\]</span></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Thomas Alexander Gerds, Johan Sebastian Ohlendorff, Brice Ozenne.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
